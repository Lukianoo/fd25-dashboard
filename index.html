<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Attack FD25 ‚Äì Profi panel vyt√°pƒõn√≠</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin: 0;
  padding: 20px;
  font-family: Arial, sans-serif;
  background: #020617;
  color: #e5e7eb;
}

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

h1 {
  margin: 0;
  font-size: 2rem;
}

.update {
  opacity: 0.8;
  font-size: 1rem;
}

.section-title {
  margin: 28px 0 10px;
  font-size: 1.2rem;
  opacity: 0.9;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
  gap: 16px;
}

.card {
  background: #020617;
  border: 1px solid #1e293b;
  border-radius: 14px;
  padding: 14px;
  text-align: center;
  box-shadow: inset 0 0 0 1px #020617;
}

.card h3 {
  margin: 0 0 8px;
  font-size: 1rem;
  opacity: 0.85;
}

.value {
  font-size: 2.6rem;
  font-weight: bold;
}

.unit {
  opacity: 0.6;
}

canvas {
  margin-top: 10px;
}
</style>
</head>

<body>

<header>
  <h1>üî• Attack FD25 ‚Äì Profi panel vyt√°pƒõn√≠</h1>
  <div class="update" id="updated">Aktualizace: ‚Äì</div>
</header>

<!-- TEPLOTY -->
<div class="section-title">Teploty syst√©mu</div>
<div class="grid">
  <div class="card"><h3>Kotel</h3><div class="value" id="kotel">‚Äì</div><div class="unit">¬∞C</div></div>
  <div class="card"><h3>V√Ωstup z kotle</h3><div class="value" id="vystup">‚Äì</div><div class="unit">¬∞C</div></div>
  <div class="card"><h3>Zp√°teƒçka</h3><div class="value" id="zpat">‚Äì</div><div class="unit">¬∞C</div></div>
  <div class="card"><h3>ŒîT (v√Ωstup ‚àí zp√°teƒçka)</h3><div class="value" id="delta">‚Äì</div><div class="unit">¬∞C</div></div>
  <div class="card"><h3>TUV</h3><div class="value" id="tuv">‚Äì</div><div class="unit">¬∞C</div></div>
  <div class="card"><h3>Venkovn√≠ teplota</h3><div class="value" id="venek">‚Äì</div><div class="unit">¬∞C</div></div>
</div>

<!-- ENERGIE -->
<div class="section-title">Oh≈ôev TUV ‚Äì energie</div>
<div class="grid">
  <div class="card"><h3>Dne≈°n√≠ energie TUV</h3><div class="value" id="today_kwh">‚Äì</div><div class="unit">kWh</div></div>
  <div class="card"><h3>Energie TUV ‚Äì posledn√≠ch 24 h</h3><div class="value" id="day24_kwh">‚Äì</div><div class="unit">kWh</div></div>
  <div class="card"><h3>Energie TUV ‚Äì tento mƒõs√≠c</h3><div class="value" id="month_kwh">‚Äì</div><div class="unit">kWh</div></div>
</div>

<!-- UHL√ç -->
<div class="section-title">Ekvivalent uhl√≠ (hnƒõd√© ‚Äì B√≠lina)</div>
<div class="grid">
  <div class="card"><h3>Dnes</h3><div class="value" id="today_coal">‚Äì</div><div class="unit">kg</div></div>
  <div class="card"><h3>Posledn√≠ch 24 h</h3><div class="value" id="day24_coal">‚Äì</div><div class="unit">kg</div></div>
  <div class="card"><h3>Tento mƒõs√≠c</h3><div class="value" id="month_coal">‚Äì</div><div class="unit">kg</div></div>
</div>

<!-- GRAF -->
<div class="section-title">Graf teplot ‚Äì posledn√≠ch 24 hodin</div>
<div class="card">
  <canvas id="chart"></canvas>
</div>

<script>
const CHANNEL_ID = 231269;

/* FYZIK√ÅLN√ç KONSTANTY */
const BOJLER_L = 125;
const CP = 4.186;
const ETA = 0.75;
const COAL_KWH = 5.0;

let chart;

function energyFromDelta(dT) {
  return BOJLER_L * CP * dT / 3600 / ETA;
}

async function fetchFeeds(results) {
  const res = await fetch(
    `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=${results}`
  );
  const data = await res.json();
  return data.feeds;
}

async function loadData() {

  /* ===== 24 HODIN ===== */
  const feeds24 = await fetchFeeds(96);
  const last = feeds24[feeds24.length - 1];

  document.getElementById("updated").textContent =
    "Aktualizace: " + new Date(last.created_at).toLocaleString("cs-CZ");

  const vystup = +last.field2;
  const zpat = +last.field1;

  document.getElementById("kotel").textContent = (+last.field5).toFixed(1);
  document.getElementById("vystup").textContent = vystup.toFixed(1);
  document.getElementById("zpat").textContent = zpat.toFixed(1);
  document.getElementById("delta").textContent = (vystup - zpat).toFixed(1);
  document.getElementById("tuv").textContent = (+last.field3).toFixed(1);
  document.getElementById("venek").textContent = (+last.field4).toFixed(1);

  let today = 0;
  let day24 = 0;

  const now = new Date(last.created_at);
  const midnight = new Date(now); midnight.setHours(0,0,0,0);

  for (let i = 1; i < feeds24.length; i++) {
    const dT = feeds24[i].field3 - feeds24[i-1].field3;
    if (dT <= 0) continue;

    const e = energyFromDelta(dT);
    day24 += e;

    if (new Date(feeds24[i-1].created_at) >= midnight) {
      today += e;
    }
  }

  document.getElementById("today_kwh").textContent = today.toFixed(1);
  document.getElementById("day24_kwh").textContent = day24.toFixed(1);
  document.getElementById("today_coal").textContent = (today / COAL_KWH).toFixed(1);
  document.getElementById("day24_coal").textContent = (day24 / COAL_KWH).toFixed(1);

  /* ===== MƒöS√çC ===== */
  const feedsLong = await fetchFeeds(8000);
  let month = 0;
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

  for (let i = 1; i < feedsLong.length; i++) {
    const tPrev = new Date(feedsLong[i-1].created_at);
    if (tPrev < monthStart) continue;

    const dT = feedsLong[i].field3 - feedsLong[i-1].field3;
    if (dT > 0) {
      month += energyFromDelta(dT);
    }
  }

  document.getElementById("month_kwh").textContent = month.toFixed(1);
  document.getElementById("month_coal").textContent = (month / COAL_KWH).toFixed(1);

  /* ===== GRAF 24 H ===== */
  const labels = feeds24.map(f =>
    new Date(f.created_at).toLocaleTimeString("cs-CZ",{hour:"2-digit",minute:"2-digit"})
  );

  const datasets = [
    {label:"V√Ωstup", field:"field2"},
    {label:"Zp√°teƒçka", field:"field1"},
    {label:"TUV", field:"field3"},
    {label:"Venkovn√≠", field:"field4"}
  ].map(c => ({
    label: c.label,
    data: feeds24.map(f => f[c.field]),
    borderWidth: 2,
    tension: 0.3
  }));

  if (chart) chart.destroy();
  chart = new Chart(document.getElementById("chart"), {
    type: "line",
    data: { labels, datasets },
    options: {
      plugins: { legend: { labels: { color:"#e5e7eb" } } },
      scales: {
        x: { ticks:{ color:"#94a3b8" } },
        y: { ticks:{ color:"#94a3b8" } }
      }
    }
  });
}

loadData();
setInterval(loadData, 60000);
</script>

</body>
</html>
