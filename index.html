<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8">
<title>Kotelna â€“ Attack FD 25</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Segoe UI,system-ui;
  background:linear-gradient(135deg,#0db8b2,#076360);
  color:#222;
}
header{
  background:#000;
  color:#fff;
  padding:15px 20px;
  display:flex;
  justify-content:space-between;
  flex-wrap: wrap;
}
main{max-width:1400px;margin:auto;padding:20px}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
}
.card{
  background:#fff;
  border-radius:14px;
  padding:20px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}
h2{margin:0 0 10px;font-size:16px;color:#1e3c72}
.value{font-size:32px;font-weight:700;color:#d32f2f}
.sub{font-size:13px;color:#555}
.green{color:#2e7d32}
.blue{color:#1565c0}
.orange{color:#ef6c00}
input{width:100%;padding:10px;font-size:15px}
.settings{display:grid;grid-template-columns:1fr 1fr;gap:15px}
button{
  padding:12px 18px;
  font-size:15px;
  border-radius:10px;
  border:none;
  background:#1e3c72;
  color:#fff;
  cursor:pointer;
  width:100%;         /* tlaÄÃ­tka zabÃ­rajÃ­ celou Å¡Ã­Å™ku */
  margin-bottom:10px; /* mezera mezi tlaÄÃ­tky */
  box-sizing:border-box;
}
  /* barvy tlaÄÃ­tek historie */
#historyBtn { background-color: #ef6c00; color: #fff; }
#monthHistoryBtn { background-color: #1565c0; color: #fff; }
#totalHistoryBtn { background-color: #2e7d32; color: #fff; }
#historyBtn:hover,
#monthHistoryBtn:hover,
#totalHistoryBtn:hover { opacity: 0.85; }
table{width:100%;border-collapse:collapse}
th,td{padding:8px;text-align:center}
th{background:#eee}
footer img{
  transition: .3s;
}
footer img:hover{
  transform: scale(1.03);
  opacity: 1;
}

/* mobilnÃ­ Ãºpravy */
@media (max-width: 600px) {
  header {
    flex-direction: column;
    align-items: flex-start;
    padding: 10px 15px;
  }
  main {
    padding: 10px;
  }
  .card {
    padding: 15px;
  }
  h2 { font-size: 14px; }
  .value { font-size: 24px; }
  .sub { font-size: 12px; }
  .settings { grid-template-columns:1fr; }
  .grid { grid-template-columns: repeat(auto-fit, minmax(150px,1fr)); }
  #historyBox table, #totalHistoryBox table {
    display: block;
    overflow-x: auto;
    white-space: nowrap;
  }
}
</style>
</head>

<body>

<header style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;padding:15px 20px;background:#000;color:#fff;">
  <!-- hodiny vlevo -->
  <div id="clock" style="font-size:25px;"></div>

  <!-- nÃ¡zev doprostÅ™ed -->
  <div style="flex:1;text-align:center;font-size:25px;font-weight:700;">
    ATTACK FD 25 AUTOMAT â€“ PANEL KOTELNY ZACHRÄŒ
  </div>

  <!-- fullscreen tlaÄÃ­tko napravo -->
  <div>
    <button id="fullscreenBtn" style="padding:6px 12px;font-size:14px;border-radius:8px;background:#6a1b9a;color:#fff;border:none;cursor:pointer;">
      â›¶ Fullscreen
    </button>
  </div>
</header>

<main>

<div class="grid">
  <div class="card"><h2>ğŸ”¥ Kotel</h2><div class="value" id="tKotel">--</div></div>
  <div class="card"><h2>â†©ï¸ ZpÃ¡teÄka</h2><div class="value blue" id="tZpet">--</div></div>
  <div class="card"><h2>ğŸŒ¡ï¸ TeplotnÃ­ spÃ¡d Î”T</h2><div class="value orange" id="deltaT">--</div></div>
  <div class="card"><h2>âš¡ AktuÃ¡lnÃ­ vÃ½kon</h2><div class="value green" id="powerKWbig">--</div></div>
  <div class="card"><h2>âš™ï¸ PodavaÄ</h2><div class="value" id="tPodavac">--</div></div>
  <div class="card"><h2>ğŸ’§ Bojler</h2><div class="value" id="tBojler">--</div></div>
  <div class="card"><h2>ğŸŒ¡ï¸ Venku</h2><div class="value" id="tVenku">--</div></div>
  <div class="card"><h2>â±ï¸ PodavaÄ celkem</h2><div class="value" id="feedTotal">--</div></div>
</div>

<br>

<div class="card">
<h2>ğŸ’° SpotÅ™eba uhlÃ­</h2>
<div class="grid">
  <div><div class="sub">HODINA</div><div class="value orange" id="kgHour">0 kg</div></div>
  <div><div class="sub">DNES</div><div class="value green" id="kgDay">0 kg</div></div>
  <div><div class="sub">MÄšSÃC</div><div class="value blue" id="kgMonth">0 kg</div></div>
  <div><div class="sub">CENA DNES</div><div class="value" id="costDay">0 KÄ</div></div>
  <div><div class="sub">CENA MÄšSÃC</div><div class="value" id="costMonth">0 KÄ</div></div>
</div>

<br>
<div class="buttons-wrapper">
  <button id="historyBtn">ğŸ“… DennÃ­ historie spotÅ™eby</button>
  <button id="monthHistoryBtn">ğŸ“† MÄ›sÃ­ÄnÃ­ historie spotÅ™eby</button>
  <button id="totalHistoryBtn">ğŸ“ˆ CelkovÃ¡ historie spotÅ™eby</button>
</div>
</div>

<div id="historyBox" class="card" style="display:none;margin-top:20px">
  <h2>ğŸ“Š DennÃ­ historie â€“ uhlÃ­ & cena</h2>
  <table>
    <thead>
      <tr>
        <th>Datum</th>
        <th>SpotÅ™eba (kg)</th>
        <th>Cena (KÄ)</th>
      </tr>
    </thead>
    <tbody id="historyTable"></tbody>
  </table>
</div>
<div id="monthHistoryBox" class="card" style="display:none;margin-top:20px">
  <h2>ğŸ“† MÄ›sÃ­ÄnÃ­ historie â€“ uhlÃ­ & cena</h2>
  <table>
    <thead>
      <tr>
        <th>MÄ›sÃ­c</th>
        <th>SpotÅ™eba (kg)</th>
        <th>Cena (KÄ)</th>
      </tr>
    </thead>
    <tbody id="monthHistoryTable"></tbody>
  </table>
</div>

<div id="totalHistoryBox" class="card" style="display:none;margin-top:20px">
  <h2>ğŸ“ˆ CelkovÃ¡ historie â€“ od zaÄÃ¡tku mÄ›Å™enÃ­</h2>
  <table>
    <thead>
      <tr>
        <th>ObdobÃ­</th>
        <th>SpotÅ™eba (kg)</th>
        <th>Cena (KÄ)</th>
      </tr>
    </thead>
    <tbody id="totalHistoryTable"></tbody>
  </table>
</div>

<br>

<div class="card">
<h2>âš™ï¸ NastavenÃ­</h2>
<div class="settings">
  <div>
    <label>Kg uhlÃ­ / 10 min</label>
    <input type="number" id="kg10min" step="0.1">
  </div>
  <div>
    <label>Cena / kg</label>
    <input type="number" id="priceKg" step="0.1">
  </div>
</div>
</div>

</main>

<script>
const CHANNEL = 231269;
const DAY_CHANNEL = 3238281; // dennÃ­ souÄty v kg
const ENERGY = 4.8;
const EFF = 0.75;

kg10min.value = localStorage.kg10min || 2.5;
priceKg.value = localStorage.priceKg || 6.2;

function updateClock(){
  clock.textContent = new Date().toLocaleString("cs-CZ");
}

function secToHMS(sec){
  sec=Math.max(0,Math.floor(sec));
  const h=Math.floor(sec/3600);
  const m=Math.floor((sec%3600)/60);
  const s=sec%60;
  return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}

function secToKg(sec){
  return Math.max(0,(sec/600)*(+kg10min.value||2.5));
}
function safeSecDiff(a, b){
  const d = a - b;
  return d > 0 ? d : 0;
}
async function getDayKg(date){
  const d1 = new Date(date);
  d1.setHours(0,0,0,0);

  const d2 = new Date(d1);
  d2.setDate(d2.getDate() + 1);

  const f = await fetchFeeds(
    `start=${localISO(d1)}&end=${localISO(d2)}&results=1000`
  );

  if (f.length < 2) return 0;

  const sec = safeSecDiff(
    f.at(-1).field8,
    f[0].field8
  );

  return secToKg(sec);
}

function todayStartISO(){
  const d = new Date();
  d.setHours(0,0,0,0);
  return localISO(d);
}


function localISO(d){
  const z = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}T${z(d.getHours())}:${z(d.getMinutes())}:${z(d.getSeconds())}`;
}

function monthStartISO(){
  const d = new Date();
  d.setDate(1);
  d.setHours(0,0,0,0);
  return localISO(d);
}
async function fetchDayFeeds(p){
  try{
    const r = await fetch(
      `https://api.thingspeak.com/channels/${DAY_CHANNEL}/feeds.json?${p}`
    );
    return (await r.json()).feeds || [];
  }catch(e){
    return [];
  }
}


async function fetchFeeds(p){
  try{
    const r=await fetch(`https://api.thingspeak.com/channels/${CHANNEL}/feeds.json?${p}`);
    return (await r.json()).feeds||[];
  }catch(e){return[];}
}

async function updateCurrent(){
  const cur=await fetchFeeds("results=1");
  if(!cur.length)return;
  const f=cur[0];
  const tK=+f.field5||0;
  const tZ=+f.field1||0;

  tKotel.textContent=tK.toFixed(1)+" Â°C";
  tZpet.textContent=tZ.toFixed(1)+" Â°C";
  tPodavac.textContent=(+f.field2||0).toFixed(1)+" Â°C";
  tBojler.textContent=(+f.field3||0).toFixed(1)+" Â°C";
  tVenku.textContent=(+f.field4||0).toFixed(1)+" Â°C";
  deltaT.textContent=(tK-tZ).toFixed(1)+" Â°C";

  const totalSec=+f.field8||0;
  feedTotal.textContent=secToHMS(totalSec);
}

async function updateHour(){
  const f=await fetchFeeds("minutes=60&results=120");
  if(f.length<2)return;
  const kg=secToKg(f.at(-1).field8-f[0].field8);
  kgHour.textContent=kg.toFixed(2)+" kg";
  powerKWbig.textContent=(kg*ENERGY*EFF).toFixed(1)+" kWh";
}

async function updateDay(){
  const f = await fetchDayFeeds("results=1");

  if(!f.length){
    kgDay.textContent = "0 kg";
    costDay.textContent = "0 KÄ";
    return;
  }

  const kg = +f[0].field1 || 0;

  kgDay.textContent = kg.toFixed(0) + " kg";
  costDay.textContent =
    (kg * (+priceKg.value || 6.2)).toFixed(0) + " KÄ";
}



async function updateMonth(){
  const now = new Date();
  const y = now.getFullYear();
  const m = now.getMonth() + 1;

  const start = `${y}-${String(m).padStart(2,"0")}-01T00:00:00`;

  const f = await fetchDayFeeds(
    `start=${start}&results=400`
  );

  let kg = 0;
  for(const d of f){
    kg += +d.field1 || 0;
  }

  kgMonth.textContent = kg.toFixed(0) + " kg";
  costMonth.textContent =
    (kg * (+priceKg.value || 6.2)).toFixed(0) + " KÄ";
}


historyBtn.onclick = async () => {
  historyBox.style.display =
    historyBox.style.display === "none" ? "block" : "none";

  historyTable.innerHTML = "";
  const price = +priceKg.value || 6.2;

  const f = await fetchDayFeeds("results=30");

  for(const d of f.reverse()){
    const kg = +d.field1 || 0;
    const date = new Date(d.created_at);

    historyTable.innerHTML += `
      <tr>
        <td>${date.toLocaleDateString("cs-CZ")}</td>
        <td>${kg.toFixed(0)}</td>
        <td>${(kg * price).toFixed(0)}</td>
      </tr>`;
  }
};



monthHistoryBtn.onclick = async () => {
  monthHistoryBox.style.display =
    monthHistoryBox.style.display === "none" ? "block" : "none";

  monthHistoryTable.innerHTML = "";
  const price = +priceKg.value || 6.2;

  const f = await fetchDayFeeds("results=400");

  const months = {};

  for(const d of f){
    const dt = new Date(d.created_at);
    const key = dt.getFullYear()+"-"+dt.getMonth();
    months[key] = (months[key] || 0) + (+d.field1 || 0);
  }

  Object.entries(months)
    .reverse()
    .slice(0,12)
    .forEach(([k,kg])=>{
      const [y,m] = k.split("-");
      const d = new Date(y, m);

      monthHistoryTable.innerHTML += `
        <tr>
          <td>${d.toLocaleDateString("cs-CZ",{month:"long",year:"numeric"})}</td>
          <td>${kg.toFixed(0)}</td>
          <td>${(kg * price).toFixed(0)}</td>
        </tr>`;
    });
};



totalHistoryBtn.onclick = async () => {
  totalHistoryBox.style.display =
    totalHistoryBox.style.display === "none" ? "block" : "none";

  totalHistoryTable.innerHTML = "";
  const price = +priceKg.value || 6.2;

  const f = await fetchDayFeeds("results=8000");

if (!f || f.length === 0){
  totalHistoryTable.innerHTML = `
    <tr>
      <td colspan="3">â›” ZatÃ­m nejsou Å¾Ã¡dnÃ¡ data</td>
    </tr>`;
  return;
}

let totalKg = 0;
f.forEach(d => totalKg += +d.field1 || 0);

const first = new Date(f.at(-1).created_at);
const last  = new Date(f[0].created_at);

  totalHistoryTable.innerHTML = `
    <tr>
      <td>${first.toLocaleDateString("cs-CZ")} â€“ ${last.toLocaleDateString("cs-CZ")}</td>
      <td>${totalKg.toFixed(0)}</td>
      <td>${(totalKg * price).toFixed(0)}</td>
    </tr>`;
};



kg10min.oninput=()=>{localStorage.kg10min=kg10min.value;updateHour();updateDay();updateMonth();}
priceKg.oninput=()=>{localStorage.priceKg=priceKg.value;updateDay();updateMonth();}

updateClock();updateCurrent();updateHour();updateDay();updateMonth();
setInterval(updateClock,1000);
setInterval(updateCurrent,30000);
setInterval(updateHour,300000);
setInterval(updateDay,900000);
setInterval(updateMonth,1800000);

fullscreenBtn.onclick = () => {
  const elem = document.documentElement; // celÃ½ dokument
  if (!document.fullscreenElement && !document.webkitFullscreenElement) {
    // ZapnutÃ­ fullscreen
    if (elem.requestFullscreen) {
      elem.requestFullscreen();
    } else if (elem.webkitRequestFullscreen) { // iOS Safari
      elem.webkitRequestFullscreen({ navigationUI: "hide" });
    } else if (elem.msRequestFullscreen) { // IE/Edge
      elem.msRequestFullscreen();
    }
  } else {
    // VypnutÃ­ fullscreen
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
      document.webkitExitFullscreen();
    } else if (document.msExitFullscreen) {
      document.msExitFullscreen();
    }
  }
};
  
</script>

<footer style="text-align:center;margin:40px 0 20px;opacity:.85">
  <img 
    src="https://raw.githubusercontent.com/Lukianoo/fd25-dashboard/main/logo-elektroservis.png"
    alt="Elektroservis logo"
    style="max-width:400px;width:100%;filter:drop-shadow(0 4px 8px rgba(0,0,0,.4))"
  >
</footer>

</body>
</html>
