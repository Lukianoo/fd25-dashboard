<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Attack FD25 â€“ Profi panel vytÃ¡pÄ›nÃ­</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background:#0f172a;
  color:#e5e7eb;
  margin:0;
  padding:20px;
}
h1 { margin-bottom:5px; }
.small { opacity:0.7; font-size:0.9rem; }

.section-title {
  margin-top:30px;
  margin-bottom:10px;
  font-size:1.2rem;
}

.grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:16px;
}
.card {
  background:#020617;
  border-radius:16px;
  padding:16px;
  box-shadow:0 10px 25px rgba(0,0,0,0.4);
}
.value {
  font-size:2.1rem;
  font-weight:bold;
}
.unit { opacity:0.7; }

canvas { margin-top:10px; }
</style>
</head>

<body>

<h1>ğŸ”¥ Attack FD25 â€“ RodinnÃ½ dÅ¯m</h1>
<div class="small">
  AutomatickÃ½ kotel FD25 Â· bojler 125 l DraÅ¾ice<br>
  â±ï¸ PoslednÃ­ aktualizace: <span id="lastUpdate">â€“</span>
</div>

<!-- TEPLOTY -->
<div class="section-title">ğŸŒ¡ï¸ Teploty</div>
<div class="grid">
  <div class="card"><div>Kotel</div><div class="value" id="f5">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div>VÃ½stup z kotle</div><div class="value" id="f2">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div>ZpÃ¡teÄka kotle</div><div class="value" id="f1">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div>Î”T (vÃ½stup âˆ’ zpÃ¡teÄka)</div><div class="value" id="deltaT">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div>TUV</div><div class="value" id="f3">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div>VenkovnÃ­ teplota</div><div class="value" id="f4">â€“</div><div class="unit">Â°C</div></div>
</div>

<!-- ENERGIE -->
<div class="section-title">ğŸš¿ SpotÅ™eba TUV</div>
<div class="grid">
  <div class="card">
    <div>DennÃ­ energie TUV (od 00:00)</div>
    <div class="value" id="energyDay">â€“</div>
    <div class="unit">kWh</div>
  </div>

  <div class="card">
    <div>DennÃ­ uhlÃ­ TUV (BÃ­lina)</div>
    <div class="value" id="coalDay">â€“</div>
    <div class="unit">kg</div>
  </div>

  <div class="card">
    <div>Energie TUV â€“ tento mÄ›sÃ­c<br>
      <span class="small">(od <span id="monthFrom">â€“</span>)</span>
    </div>
    <div class="value" id="energyMonth">â€“</div>
    <div class="unit">kWh</div>
  </div>

  <div class="card">
    <div>UhlÃ­ TUV â€“ tento mÄ›sÃ­c (BÃ­lina)</div>
    <div class="value" id="coalMonth">â€“</div>
    <div class="unit">kg</div>
  </div>
</div>

<!-- GRAF -->
<div class="section-title">ğŸ“ˆ Historie teplot (24 h)</div>
<div class="card">
  <canvas id="chart"></canvas>
</div>

<script>
const CHANNEL_ID = 231269;
const BOILER_VOLUME = 125;      // l
const COAL_KWH_PER_KG = 0.27;
const RESULTS_24H = 96;

let chart;

function r1(v){ return (!isNaN(v) && v!==null) ? Number(v).toFixed(1) : 'â€“'; }

async function loadData() {

  /* ==== 24 HODIN ==== */
  const res24 = await fetch(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=${RESULTS_24H}`);
  const data24 = await res24.json();
  const feeds24 = data24.feeds;
  const last = feeds24.at(-1);

  document.getElementById('lastUpdate').textContent =
    new Date(last.created_at).toLocaleString('cs-CZ');

  ['1','2','3','4','5'].forEach(i=>{
    document.getElementById('f'+i).textContent = r1(last['field'+i]);
  });

  document.getElementById('deltaT').textContent =
    r1(last.field2 - last.field1);

  /* ==== CELÃ HISTORIE ==== */
  const resAll = await fetch(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=8000`);
  const all = (await resAll.json()).feeds;

  const now = new Date();
  const startDay = new Date(now); startDay.setHours(0,0,0,0);
  const startMonth = new Date(now.getFullYear(), now.getMonth(), 1);

  document.getElementById('monthFrom').textContent =
    startMonth.toLocaleDateString('cs-CZ');

  let eDay = 0, eMonth = 0;

  for(let i=1;i<all.length;i++){
    const prev = all[i-1];
    const cur = all[i];
    const t = new Date(cur.created_at);
    const dT = cur.field3 - prev.field3;

    if(dT > 0){
      const e = BOILER_VOLUME * dT * 0.001163;
      if(t >= startDay)   eDay   += e;
      if(t >= startMonth) eMonth += e;
    }
  }

  document.getElementById('energyDay').textContent = r1(eDay);
  document.getElementById('coalDay').textContent   = r1(eDay / COAL_KWH_PER_KG);
  document.getElementById('energyMonth').textContent = r1(eMonth);
  document.getElementById('coalMonth').textContent   = r1(eMonth / COAL_KWH_PER_KG);

  /* ==== GRAF 24 H ==== */
  const labels = feeds24.map(f =>
    new Date(f.created_at).toLocaleTimeString('cs-CZ',{hour:'2-digit',minute:'2-digit'})
  );

  const cfg = [
    {l:'Kotel',f:'field5'},
    {l:'VÃ½stup',f:'field2'},
    {l:'ZpÃ¡teÄka',f:'field1'},
    {l:'TUV',f:'field3'},
    {l:'VenkovnÃ­',f:'field4'}
  ];

  const datasets = cfg.map(c=>({
    label:c.l,
    data:feeds24.map(f=>f[c.f]),
    borderWidth:2,
    tension:0.3
  }));

  if(chart) chart.destroy();
  chart = new Chart(chartElem,{
    type:'line',
    data:{labels,datasets},
    options:{
      plugins:{legend:{labels:{color:'#e5e7eb'}}},
      scales:{
        x:{ticks:{color:'#94a3b8'}},
        y:{ticks:{color:'#94a3b8'}}
      }
    }
  });
}

const chartElem = document.getElementById('chart');
loadData();
setInterval(loadData,60000);
</script>

</body>
</html>
