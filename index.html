<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Attack FD25 â€“ Profi panel vytÃ¡pÄ›nÃ­</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background:#0f172a;
  color:#e5e7eb;
  margin:0;
  padding:20px;
}
h1 { margin-bottom:5px; }
small { color:#94a3b8; }

.grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:15px;
}
.card {
  background:#020617;
  border-radius:14px;
  padding:14px;
  box-shadow:0 8px 20px rgba(0,0,0,.4);
}
.value {
  font-size:2.1rem;
  font-weight:bold;
}
.unit { opacity:.7; }

input, select {
  width:100%;
  padding:6px;
  margin-top:5px;
  background:#020617;
  color:#e5e7eb;
  border:1px solid #334155;
  border-radius:6px;
}

.section {
  margin-top:25px;
}

canvas { margin-top:15px; }
</style>
</head>

<body>

<h1>ğŸ”¥ Attack FD25 â€“ Profi panel vytÃ¡pÄ›nÃ­</h1>
<small>PoslednÃ­ aktualizace: <span id="lastUpdate">â€“</span></small>

<!-- ================= TEPLOTY ================= -->
<div class="section grid">
  <div class="card"><div>Kotel</div><div class="value" id="f5">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div>VÃ½stup</div><div class="value" id="f2">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div>ZpÃ¡teÄka</div><div class="value" id="f1">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div>Î”T topenÃ­</div><div class="value" id="dt">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div>TUV</div><div class="value" id="f3">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div>VenkovnÃ­</div><div class="value" id="f4">â€“</div><div class="unit">Â°C</div></div>
</div>

<!-- ================= CERPADLO ================= -->
<div class="section grid">
  <div class="card">
    <div>ÄŒerpadlo â€“ pÅ™Ã­kon (W)</div>
    <input id="pumpPower" type="number" step="1">
  </div>
  <div class="card">
    <div>ReÅ¾im Äerpadla</div>
    <select id="pumpMode">
      <option value="auto">AUTOADAPT</option>
      <option value="cp">KonstantnÃ­ tlak</option>
      <option value="cs">KonstantnÃ­ otÃ¡Äky</option>
    </select>
  </div>
  <div class="card">
    <div>Odhad prÅ¯toku</div>
    <div class="value" id="flow">â€“</div>
    <div class="unit">l/h</div>
  </div>
  <div class="card">
    <div>OkamÅ¾itÃ½ vÃ½kon topenÃ­</div>
    <div class="value" id="powerHeat">â€“</div>
    <div class="unit">kW</div>
  </div>
</div>

<!-- ================= SPOTREBA ================= -->
<div class="section grid">
  <div class="card">
    <div>DennÃ­ energie â€“ TOPENÃ</div>
    <div class="value" id="dayHeat">â€“</div>
    <div class="unit">kWh</div>
  </div>
  <div class="card">
    <div>MÄ›sÃ­ÄnÃ­ energie â€“ TOPENÃ</div>
    <div class="value" id="monthHeat">â€“</div>
    <div class="unit">kWh</div>
  </div>
  <div class="card">
    <div>UhlÃ­ â€“ TOPENÃ (mÄ›sÃ­c)</div>
    <div class="value" id="coalHeat">â€“</div>
    <div class="unit">kg</div>
  </div>
  <div class="card">
    <div>Energie TUV â€“ tento mÄ›sÃ­c<br><small id="tuvFrom">od â€“</small></div>
    <div class="value" id="monthTUV">â€“</div>
    <div class="unit">kWh</div>
  </div>
</div>

<!-- ================= GRAF ================= -->
<div class="section card">
  <h3>ğŸ“ˆ Teploty â€“ poslednÃ­ch 24 h</h3>
  <canvas id="chart"></canvas>
</div>

<script>
const CHANNEL_ID = 231269;
const RESULTS = 96;
const COAL_PER_KWH = 0.27;

let dailyHeat = 0;
let monthlyHeat = 0;
let monthlyTUV = 0;
let lastTime = null;
let chart;

function flowFromPump(power, mode) {
  let factor = 1;
  if (mode === 'cp') factor = 0.9;
  if (mode === 'cs') factor = 1.1;
  return power * 60 * factor;
}

function savePump() {
  localStorage.setItem('pumpPower', pumpPower.value);
  localStorage.setItem('pumpMode', pumpMode.value);
}

pumpPower.value = localStorage.getItem('pumpPower') || 15;
pumpMode.value = localStorage.getItem('pumpMode') || 'auto';
pumpPower.onchange = savePump;
pumpMode.onchange = savePump;

async function loadData() {
  const res = await fetch(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=${RESULTS}`);
  const data = await res.json();
  const feeds = data.feeds;
  const last = feeds.at(-1);

  document.getElementById('lastUpdate').textContent =
    new Date(last.created_at).toLocaleString('cs-CZ');

  const f = n => parseFloat(last[`field${n}`]);
  document.getElementById('f1').textContent = f(1).toFixed(1);
  document.getElementById('f2').textContent = f(2).toFixed(1);
  document.getElementById('f3').textContent = f(3).toFixed(1);
  document.getElementById('f4').textContent = f(4).toFixed(1);
  document.getElementById('f5').textContent = f(5).toFixed(1);

  const dt = f(2) - f(1);
  document.getElementById('dt').textContent = dt.toFixed(1);

  const flow = flowFromPump(+pumpPower.value, pumpMode.value);
  document.getElementById('flow').textContent = Math.round(flow);

  const powerHeat = 0.00116 * flow * dt;
  document.getElementById('powerHeat').textContent = powerHeat.toFixed(1);

  const time = new Date(last.created_at);
  if (lastTime) {
    const hours = (time - lastTime) / 3600000;
    dailyHeat += powerHeat * hours;
    monthlyHeat += powerHeat * hours;
  }
  lastTime = time;

  document.getElementById('dayHeat').textContent = dailyHeat.toFixed(1);
  document.getElementById('monthHeat').textContent = monthlyHeat.toFixed(0);
  document.getElementById('coalHeat').textContent = (monthlyHeat * COAL_PER_KWH).toFixed(0);

  if (!localStorage.getItem('tuvStart')) {
    localStorage.setItem('tuvStart', time.toLocaleDateString('cs-CZ'));
  }
  document.getElementById('tuvFrom').textContent =
    "od " + localStorage.getItem('tuvStart');
  document.getElementById('monthTUV').textContent = monthlyTUV.toFixed(1);

  drawChart(feeds);
}

function drawChart(feeds) {
  const labels = feeds.map(f =>
    new Date(f.created_at).toLocaleTimeString('cs-CZ',{hour:'2-digit',minute:'2-digit'}));

  const dataSets = [
    {label:'VÃ½stup', field:'field2'},
    {label:'ZpÃ¡teÄka', field:'field1'},
    {label:'TUV', field:'field3'}
  ].map(c => ({
    label:c.label,
    data:feeds.map(f=>f[c.field]),
    borderWidth:2,
    tension:0.3
  }));

  if (chart) chart.destroy();
  chart = new Chart(chartEl, {
    type:'line',
    data:{labels,datasets:dataSets},
    options:{
      plugins:{legend:{labels:{color:'#e5e7eb'}}},
      scales:{x:{ticks:{color:'#94a3b8'}},y:{ticks:{color:'#94a3b8'}}}
    }
  });
}

loadData();
setInterval(loadData,60000);
</script>

</body>
</html>
