<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="utf-8">
<title>Kotelna â€“ Attack FD 25</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Segoe UI,system-ui;
  background:linear-gradient(135deg,#1e3c72,#2a5298);
  color:#222;
}
header{
  background:#000;
  color:#fff;
  padding:15px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
header button{
  background:#1e3c72;
  color:#fff;
  border:none;
  border-radius:8px;
  padding:8px 12px;
  font-size:14px;
  cursor:pointer;
}
main{max-width:1400px;margin:auto;padding:20px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px}
.card{background:#fff;border-radius:14px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25);}
h2{margin:0 0 10px;font-size:16px;color:#1e3c72}
.value{font-size:32px;font-weight:700;color:#d32f2f}
.sub{font-size:13px;color:#555}
.green{color:#2e7d32}
.blue{color:#1565c0}
.orange{color:#ef6c00}
input{width:100%;padding:10px;font-size:15px}
.settings{display:grid;grid-template-columns:1fr 1fr;gap:15px}
button{padding:12px 18px;font-size:15px;border-radius:10px;border:none;background:#1e3c72;color:#fff;cursor:pointer}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;text-align:center}
th{background:#eee}
</style>
</head>
<body>
<header>
  <div id="clock"></div>
  <div>Attack FD 25 â€“ Profi panel</div>
  <button id="fsBtn">â›¶ Fullscreen</button>
</header>
<main>
  <div class="grid">
    <div class="card"><h2>ğŸ”¥ Kotel</h2><div class="value" id="tKotel">--</div></div>
    <div class="card"><h2>â†©ï¸ ZpÃ¡teÄka</h2><div class="value blue" id="tZpet">--</div></div>
    <div class="card"><h2>ğŸŒ¡ï¸ Î”T</h2><div class="value orange" id="deltaT">--</div></div>
    <div class="card"><h2>âš¡ Energie (1 h)</h2><div class="value green" id="powerKWbig">--</div></div>
    <div class="card"><h2>âš™ï¸ PodavaÄ</h2><div class="value" id="tPodavac">--</div></div>
    <div class="card"><h2>ğŸ’§ Bojler</h2><div class="value" id="tBojler">--</div></div>
    <div class="card"><h2>ğŸŒ¡ï¸ Venku</h2><div class="value" id="tVenku">--</div></div>
    <div class="card"><h2>â±ï¸ PodavaÄ celkem</h2><div class="value" id="feedTotal">--</div></div>
  </div>
  <br>
  <div class="card">
    <h2>ğŸ’° SpotÅ™eba uhlÃ­</h2>
    <div class="grid">
      <div><div class="sub">HODINA</div><div class="value orange" id="kgHour">0 kg</div></div>
      <div><div class="sub">DNES</div><div class="value green" id="kgDay">0 kg</div></div>
      <div><div class="sub">MÄšSÃC</div><div class="value blue" id="kgMonth">0 kg</div></div>
      <div><div class="sub">CENA DNES</div><div class="value" id="costDay">0 KÄ</div></div>
      <div><div class="sub">CENA MÄšSÃC</div><div class="value" id="costMonth">0 KÄ</div></div>
    </div>
    <br>
    <button id="historyBtn">ğŸ“… DennÃ­ historie spotÅ™eby</button>
  </div>
  <div id="historyBox" class="card" style="display:none;margin-top:20px">
    <h2>ğŸ“Š DennÃ­ historie â€“ uhlÃ­ & cena</h2>
    <table>
      <thead>
        <tr>
          <th>Datum</th>
          <th>SpotÅ™eba (kg)</th>
          <th>Cena (KÄ)</th>
        </tr>
      </thead>
      <tbody id="historyTable"></tbody>
    </table>
  </div>
  <br>
  <div class="card">
    <h2>âš™ï¸ NastavenÃ­</h2>
    <div class="settings">
      <div>
        <label>Kg uhlÃ­ / 10 min</label>
        <input type="number" id="kg10min" step="0.1">
      </div>
      <div>
        <label>Cena / kg</label>
        <input type="number" id="priceKg" step="0.1">
      </div>
    </div>
  </div>
</main>
<script>
const CHANNEL = 231269;
const ENERGY = 4.8;
const EFF = 0.75;

// DOM Elements
const kg10min = document.getElementById("kg10min");
const priceKg = document.getElementById("priceKg");
const clock = document.getElementById("clock");
const fsBtn = document.getElementById("fsBtn");
const tKotel = document.getElementById("tKotel");
const tZpet = document.getElementById("tZpet");
const deltaT = document.getElementById("deltaT");
const tPodavac = document.getElementById("tPodavac");
const tBojler = document.getElementById("tBojler");
const tVenku = document.getElementById("tVenku");
const feedTotal = document.getElementById("feedTotal");
const kgHour = document.getElementById("kgHour");
const powerKWbig = document.getElementById("powerKWbig");
const kgDay = document.getElementById("kgDay");
const kgMonth = document.getElementById("kgMonth");
const costDay = document.getElementById("costDay");
const costMonth = document.getElementById("costMonth");

// Load settings
kg10min.value = localStorage.kg10min || 2.5;
priceKg.value = localStorage.priceKg || 6.2;

// Clock
function updateClock(){
  clock.textContent = new Date().toLocaleString("cs-CZ");
}

// Fullscreen
function toggleFullscreen(){
  if(!document.fullscreenElement){
    document.documentElement.requestFullscreen();
  } else {
    document.exitFullscreen();
  }
}
fsBtn.onclick = toggleFullscreen;
document.addEventListener("fullscreenchange", () => {
  fsBtn.textContent = document.fullscreenElement ? "â›¶ UkonÄit" : "â›¶ Fullscreen";
});

// Format seconds to hh:mm:ss
function secToHMS(sec){
  sec = Math.max(0, Math.floor(sec));
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  const s = sec % 60;
  return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}

// Convert seconds to kg
function secToKg(sec){
  return Math.max(0,(sec/600)*(+kg10min.value||2.5));
}

// Start/end for Thingspeak
function todayStartEnd(){
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  const end = new Date(start);
  end.setDate(end.getDate()+1);
  return {start: start.toISOString(), end: end.toISOString()};
}

function monthStartEnd(){
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth(), 1);
  const end = new Date(start);
  end.setMonth(end.getMonth()+1);
  return {start: start.toISOString(), end: end.toISOString()};
}

// Fetch feeds
async function fetchFeeds(params){
  try{
    const r = await fetch(`https://api.thingspeak.com/channels/${CHANNEL}/feeds.json?${params}`);
    const data = await r.json();
    return data.feeds || [];
  }catch{
    return [];
  }
}

// Update functions
async function updateCurrent(){
  const feeds = await fetchFeeds("results=1");
  const f = feeds[0];
  if(!f) return;
  const tK = +f.field5 || 0;
  const tZ = +f.field1 || 0;
  tKotel.textContent = tK.toFixed(1) + " Â°C";
  tZpet.textContent = tZ.toFixed(1) + " Â°C";
  tPodavac.textContent = (+f.field2||0).toFixed(1) + " Â°C";
  tBojler.textContent = (+f.field3||0).toFixed(1) + " Â°C";
  tVenku.textContent = (+f.field4||0).toFixed(1) + " Â°C";
  deltaT.textContent = (tK - tZ).toFixed(1) + " Â°C";
  feedTotal.textContent = secToHMS(+f.field8||0);
}

async function updateHour(){
  const feeds = await fetchFeeds("minutes=60&results=120");
  if(feeds.length<1) return;
  const sec1 = +(feeds[0].field8||0);
  const sec2 = +(feeds[feeds.length-1].field8||0);
  const kg = secToKg(sec2 - sec1);
  kgHour.textContent = kg.toFixed(2) + " kg";
  powerKWbig.textContent = (kg*ENERGY*EFF).toFixed(1) + " kWh";
}

async function updateDay(){
  const {start, end} = todayStartEnd();
  const feeds = await fetchFeeds(`start=${start}&end=${end}`);
  let kg = 0;
  if(feeds.length >= 2){
    const sec1 = +(feeds[0].field8||0);
    const sec2 = +(feeds[feeds.length-1].field8||0);
    kg = secToKg(sec2 - sec1);
  } else if(feeds.length === 1){
    kg = secToKg(+(feeds[0].field8||0));
  }
  kgDay.textContent = kg.toFixed(2) + " kg";
  costDay.textContent = (kg*(+priceKg.value||6.2)).toFixed(0) + " KÄ";
}

async function updateMonth(){
  const {start, end} = monthStartEnd();
  const feeds = await fetchFeeds(`start=${start}&end=${end}`);
  let kg = 0;
  if(feeds.length >= 2){
    const sec1 = +(feeds[0].field8||0);
    const sec2 = +(feeds[feeds.length-1].field8||0);
    kg = secToKg(sec2 - sec1);
  } else if(feeds.length === 1){
    kg = secToKg(+(feeds[0].field8||0));
  }
  kgMonth.textContent = kg.toFixed(0) + " kg";
  costMonth.textContent = (kg*(+priceKg.value||6.2)).toFixed(0) + " KÄ";
}

// Input handlers
kg10min.oninput = ()=>{
  localStorage.kg10min = kg10min.value;
  updateHour();
  updateDay();
  updateMonth();
}
priceKg.oninput = ()=>{
  localStorage.priceKg = priceKg.value;
  updateDay();
  updateMonth();
}

// Initial update
updateClock();
updateCurrent();
updateHour();
updateDay();
updateMonth();

// Intervals
setInterval(updateClock,1000);
setInterval(updateCurrent,30000);
setInterval(updateHour,300000);
setInterval(updateDay,900000);
setInterval(updateMonth,1800000);
</script>
</body>
</html>
