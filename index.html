<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8">
<title>Kotelna â€“ Attack FD 25</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Segoe UI,system-ui;
  background:linear-gradient(135deg,#0db8b2,#076360);
  color:#222;
}
header{
  background:#000;
  color:#fff;
  padding:15px 20px;
  display:flex;
  justify-content:space-between;
  flex-wrap: wrap;
  align-items:center;
}
main{max-width:1400px;margin:auto;padding:20px}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
}
.card{
  background:#fff;
  border-radius:14px;
  padding:20px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}
h2{margin:0 0 10px;font-size:16px;color:#1e3c72}
.value{font-size:32px;font-weight:700;color:#d32f2f}
.sub{font-size:13px;color:#555}
.green{color:#2e7d32}
.blue{color:#1565c0}
.orange{color:#ef6c00}
input{width:100%;padding:10px;font-size:15px}
.settings{display:grid;grid-template-columns:1fr 1fr;gap:15px}
button{
  padding:12px 18px;
  font-size:15px;
  border-radius:10px;
  border:none;
  background:#1e3c72;
  color:#fff;
  cursor:pointer;
  width:100%;
  margin-bottom:10px;
  box-sizing:border-box;
}
#historyBtn { background-color: #ef6c00; }
#monthHistoryBtn { background-color: #1565c0; }
#totalHistoryBtn { background-color: #2e7d32; }
#historyBtn:hover,
#monthHistoryBtn:hover,
#totalHistoryBtn:hover { opacity: 0.85; }
table{width:100%;border-collapse:collapse}
th,td{padding:8px;text-align:center}
th{background:#eee}
footer img{
  transition: .3s;
}
footer img:hover{
  transform: scale(1.03);
  opacity: 1;
}
@media (max-width: 600px) {
  header { flex-direction: column; align-items: flex-start; padding: 10px 15px; }
  main { padding: 10px; }
  .card { padding: 15px; }
  h2 { font-size: 14px; }
  .value { font-size: 24px; }
  .sub { font-size: 12px; }
  .settings { grid-template-columns:1fr; }
  .grid { grid-template-columns: repeat(auto-fit, minmax(150px,1fr)); }
  #historyBox table, #totalHistoryBox table {
    display: block;
    overflow-x: auto;
    white-space: nowrap;
  }
}
</style>
</head>
<body>

<header>
  <div id="clock" style="font-size:25px;"></div>
  <div style="flex:1;text-align:center;font-size:25px;font-weight:700;">
    ATTACK FD 25 AUTOMAT â€“ PANEL KOTELNY ZACHRÄŒ
  </div>
  <button id="fullscreenBtn" style="padding:6px 12px;font-size:14px;border-radius:8px;background:#6a1b9a;color:#fff;border:none;cursor:pointer;">
    â›¶ Fullscreen
  </button>
</header>

<main>
<div class="grid">
  <div class="card"><h2>ğŸ”¥ Kotel</h2><div class="value" id="tKotel">--</div></div>
  <div class="card"><h2>â†©ï¸ ZpÃ¡teÄka</h2><div class="value blue" id="tZpet">--</div></div>
  <div class="card"><h2>ğŸŒ¡ï¸ TeplotnÃ­ spÃ¡d Î”T</h2><div class="value orange" id="deltaT">--</div></div>
  <div class="card"><h2>âš¡ AktuÃ¡lnÃ­ vÃ½kon</h2><div class="value green" id="powerKWbig">--</div></div>
  <div class="card"><h2>âš™ï¸ PodavaÄ</h2><div class="value" id="tPodavac">--</div></div>
  <div class="card"><h2>ğŸ’§ Bojler</h2><div class="value" id="tBojler">--</div></div>
  <div class="card"><h2>ğŸŒ¡ï¸ Venku</h2><div class="value" id="tVenku">--</div></div>
  <div class="card"><h2>â±ï¸ PodavaÄ celkem</h2><div class="value" id="feedTotal">--</div></div>
</div>

<br>

<div class="card">
  <h2>ğŸ’° SpotÅ™eba uhlÃ­</h2>
  <div class="grid">
    <div><div class="sub">HODINA</div><div class="value orange" id="kgHour">0 kg</div></div>
    <div><div class="sub">DNES</div><div class="value green" id="kgDay">naÄÃ­tÃ¡m...</div></div>
    <div><div class="sub">MÄšSÃC</div><div class="value blue" id="kgMonth">0 kg</div></div>
    <div><div class="sub">CENA DNES</div><div class="value" id="costDay">0 KÄ</div></div>
    <div><div class="sub">CENA MÄšSÃC</div><div class="value" id="costMonth">0 KÄ</div></div>
  </div>
  <br>
  <div class="buttons-wrapper">
    <button id="historyBtn">ğŸ“… DennÃ­ historie spotÅ™eby</button>
    <button id="monthHistoryBtn">ğŸ“† MÄ›sÃ­ÄnÃ­ historie spotÅ™eby</button>
    <button id="totalHistoryBtn">ğŸ“ˆ CelkovÃ¡ historie spotÅ™eby</button>
  </div>
</div>

<div id="historyBox" class="card" style="display:none;margin-top:20px">
  <h2>ğŸ“Š DennÃ­ historie â€“ uhlÃ­ & cena</h2>
  <table><thead><tr><th>Datum</th><th>SpotÅ™eba (kg)</th><th>Cena (KÄ)</th></tr></thead><tbody id="historyTable"></tbody></table>
</div>

<div id="monthHistoryBox" class="card" style="display:none;margin-top:20px">
  <h2>ğŸ“† MÄ›sÃ­ÄnÃ­ historie â€“ uhlÃ­ & cena</h2>
  <table><thead><tr><th>MÄ›sÃ­c</th><th>SpotÅ™eba (kg)</th><th>Cena (KÄ)</th></tr></thead><tbody id="monthHistoryTable"></tbody></table>
</div>

<div id="totalHistoryBox" class="card" style="display:none;margin-top:20px">
  <h2>ğŸ“ˆ CelkovÃ¡ historie â€“ od zaÄÃ¡tku mÄ›Å™enÃ­</h2>
  <table><thead><tr><th>ObdobÃ­</th><th>SpotÅ™eba (kg)</th><th>Cena (KÄ)</th></tr></thead><tbody id="totalHistoryTable"></tbody></table>
</div>

<br>

<div class="card">
  <h2>âš™ï¸ NastavenÃ­</h2>
  <div class="settings">
    <div>
      <label>Kg uhlÃ­ / 10 min</label>
      <input type="number" id="kg10min" step="0.1">
    </div>
    <div>
      <label>Cena / kg</label>
      <input type="number" id="priceKg" step="0.1">
    </div>
  </div>
</div>

</main>

<script>
const CHANNEL = 231269;
const DAY_CHANNEL = 3238281;
const ENERGY = 4.8;
const EFF = 0.75;

let kg10min = document.getElementById('kg10min');
let priceKg = document.getElementById('priceKg');
kg10min.value = localStorage.kg10min || 2.5;
priceKg.value = localStorage.priceKg || 6.2;

const clock = document.getElementById('clock');
const tKotel    = document.getElementById('tKotel');
const tZpet     = document.getElementById('tZpet');
const deltaT    = document.getElementById('deltaT');
const powerKWbig= document.getElementById('powerKWbig');
const tPodavac  = document.getElementById('tPodavac');
const tBojler   = document.getElementById('tBojler');
const tVenku    = document.getElementById('tVenku');
const feedTotal = document.getElementById('feedTotal');
const kgHour    = document.getElementById('kgHour');
const kgDay     = document.getElementById('kgDay');
const kgMonth   = document.getElementById('kgMonth');
const costDay   = document.getElementById('costDay');
const costMonth = document.getElementById('costMonth');

async function fetchFeeds(p) {
  try {
    const r = await fetch(`https://api.thingspeak.com/channels/${CHANNEL}/feeds.json?${p}`);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const data = await r.json();
    return data.feeds || [];
  } catch (e) {
    console.error("fetchFeeds error:", e);
    return [];
  }
}

async function fetchDayFeeds(p) {
  try {
    const r = await fetch(`https://api.thingspeak.com/channels/${DAY_CHANNEL}/feeds.json?${p}`);
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const data = await r.json();
    return data.feeds || [];
  } catch (e) {
    console.error("fetchDayFeeds error:", e);
    return [];
  }
}

function updateClock() {
  clock.textContent = new Date().toLocaleString("cs-CZ", {
    dateStyle: "medium",
    timeStyle: "medium"
  });
}

function secToHMS(sec) {
  sec = Math.max(0, Math.floor(sec));
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  const s = sec % 60;
  return `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}

function secToKg(sec) {
  return Math.max(0, (sec / 600) * (Number(kg10min.value) || 2.5));
}

function safeSecDiff(a, b) {
  const d = Number(a) - Number(b);
  return d > 0 ? d : 0;
}

function todayStartISO() {
  const d = new Date();
  d.setHours(0, 0, 0, 0);
  const pad = n => String(n).padStart(2, '0');
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T00:00:00`;
}

function fmtTemp(v) {
  const n = Number(v);
  return Number.isFinite(n) ? n.toFixed(1) : "--";
}

async function updateCurrent() {
  const feeds = await fetchFeeds("results=1");
  if (!feeds.length) return;

  const f = feeds[0];
  const tk = Number(f.field5);
  const tz = Number(f.field1);

  tKotel.textContent    = fmtTemp(tk)    + " Â°C";
  tZpet.textContent     = fmtTemp(tz)    + " Â°C";
  deltaT.textContent    = fmtTemp(tk - tz) + " Â°C";
  tPodavac.textContent  = fmtTemp(f.field2) + " Â°C";
  tBojler.textContent   = fmtTemp(f.field3) + " Â°C";
  tVenku.textContent    = fmtTemp(f.field4) + " Â°C";
  feedTotal.textContent = secToHMS(Number(f.field8) || 0);
}

async function updateHour() {
  const f = await fetchFeeds("minutes=60&results=120");
  if (f.length < 2) {
    kgHour.textContent = "â€” kg";
    powerKWbig.textContent = "â€” kWh";
    return;
  }
  const sec = safeSecDiff(f.at(-1).field8, f[0].field8);
  const kg = secToKg(sec);
  kgHour.textContent = kg.toFixed(2) + " kg";
  powerKWbig.textContent = (kg * ENERGY * EFF).toFixed(1) + " kWh";
}

async function updateDay() {
  kgDay.textContent = "naÄÃ­tÃ¡m...";
  costDay.textContent = "naÄÃ­tÃ¡m...";

  const price = Number(priceKg.value) || 6.2;
  const start = todayStartISO();
  const end = new Date().toISOString().slice(0,19);

  const feeds = await fetchFeeds(`start=${start}&end=${end}&results=300`);

  let kg = 0;
  if (feeds.length >= 2) {
    const sec = safeSecDiff(feeds.at(-1).field8, feeds[0].field8);
    kg = secToKg(sec);
  } // else â†’ zÅ¯stane 0 kg

  kgDay.textContent   = kg.toFixed(0) + " kg";
  costDay.textContent = (kg * price).toFixed(0) + " KÄ";
}

async function updateMonth() {
  // Zde stÃ¡le pouÅ¾Ã­vÃ¡me dennÃ­ kanÃ¡l (souhrny za minulÃ© dny + pÅ™Ã­padnÄ› ÄÃ¡st dneÅ¡ka)
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth() + 1).padStart(2, '0');
  const start = `${y}-${m}-01T00:00:00`;

  const f = await fetchDayFeeds(`start=${start}&results=400`);
  let kg = 0;
  for (const d of f) {
    kg += Number(d.field1) || 0;
  }

  const price = Number(priceKg.value) || 6.2;
  kgMonth.textContent = kg.toFixed(0) + " kg";
  costMonth.textContent = (kg * price).toFixed(0) + " KÄ";
}

// Historie â€“ zÅ¯stÃ¡vÃ¡ z dennÃ­ho kanÃ¡lu (minulÃ© dny)
historyBtn.onclick = async () => {
  const box = document.getElementById('historyBox');
  box.style.display = box.style.display === "none" ? "block" : "none";
  if (box.style.display === "none") return;

  const table = document.getElementById('historyTable');
  table.innerHTML = "<tr><td colspan='3'>naÄÃ­tÃ¡m...</td></tr>";

  const price = Number(priceKg.value) || 6.2;
  const f = await fetchDayFeeds("results=30");
  const map = {};
  for (const d of f) {
    const day = new Date(d.created_at).toLocaleDateString("cs-CZ");
    map[day] = (map[day] || 0) + (Number(d.field1) || 0);
  }

  table.innerHTML = "";
  Object.entries(map).reverse().forEach(([day, kg]) => {
    table.innerHTML += `<tr><td>${day}</td><td>${kg.toFixed(0)}</td><td>${(kg * price).toFixed(0)}</td></tr>`;
  });
};

// monthHistoryBtn a totalHistoryBtn zÅ¯stÃ¡vajÃ­ podobnÄ› (mÅ¯Å¾eÅ¡ doladit podle potÅ™eby)

kg10min.oninput = () => {
  localStorage.kg10min = kg10min.value;
  updateHour();
  updateDay();
};

priceKg.oninput = () => {
  localStorage.priceKg = priceKg.value;
  updateDay();
  updateMonth();
};

document.getElementById('fullscreenBtn').onclick = () => {
  const elem = document.documentElement;
  if (!document.fullscreenElement) {
    elem.requestFullscreen?.() || elem.webkitRequestFullscreen?.();
  } else {
    document.exitFullscreen?.() || document.webkitExitFullscreen?.();
  }
};

// spuÅ¡tÄ›nÃ­
updateClock();
updateCurrent();
updateHour();
updateDay();
updateMonth();

setInterval(updateClock, 10000);
setInterval(updateCurrent, 30000);
setInterval(updateHour, 300000);
setInterval(updateDay, 60000);     // ÄastÄ›ji â€“ protoÅ¾e chceme prÅ¯bÄ›Å¾nou hodnotu dnes
setInterval(updateMonth, 1800000);

</script>

<footer style="text-align:center;margin:40px 0 20px;opacity:.85">
  <img
    src="https://raw.githubusercontent.com/Lukianoo/fd25-dashboard/main/logo-elektroservis.png"
    alt="Elektroservis logo"
    style="max-width:400px;width:100%;filter:drop-shadow(0 4px 8px rgba(0,0,0,.4))"
  >
</footer>

</body>
</html>
