<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Attack FD25 â€“ Profi panel vytÃ¡pÄ›nÃ­</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background:#0f172a;
  color:#e5e7eb;
  margin:0;
  padding:20px;
}
h1 { margin-bottom:4px; }
small { color:#94a3b8; }

.grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:14px;
}
.card {
  background:#020617;
  border-radius:14px;
  padding:14px;
  box-shadow:0 8px 20px rgba(0,0,0,.4);
}
.value {
  font-size:2rem;
  font-weight:bold;
}
.unit { opacity:.7; }

input, select {
  width:100%;
  padding:6px;
  margin-top:6px;
  background:#020617;
  color:#e5e7eb;
  border:1px solid #334155;
  border-radius:6px;
}

.section { margin-top:22px; }
canvas { margin-top:12px; }
</style>
</head>

<body>

<h1>ğŸ”¥ Attack FD25 â€“ Profi panel vytÃ¡pÄ›nÃ­</h1>
<small>PoslednÃ­ aktualizace: <span id="lastUpdate">â€“</span></small>

<!-- TEPLOTY -->
<div class="section grid">
  <div class="card"><div>Kotel</div><div class="value" id="f5">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div>VÃ½stup</div><div class="value" id="f2">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div>ZpÃ¡teÄka</div><div class="value" id="f1">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div>Î”T</div><div class="value" id="dt">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div>TUV</div><div class="value" id="f3">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div>VenkovnÃ­</div><div class="value" id="f4">â€“</div><div class="unit">Â°C</div></div>
</div>

<!-- CERPADLO -->
<div class="section grid">
  <div class="card">
    <div>PÅ™Ã­kon Äerpadla (W)</div>
    <input id="pumpPower" type="number" step="1">
  </div>
  <div class="card">
    <div>ReÅ¾im Äerpadla</div>
    <select id="pumpMode">
      <option value="auto">AUTOADAPT</option>
      <option value="cp">KonstantnÃ­ tlak</option>
      <option value="cs">KonstantnÃ­ otÃ¡Äky</option>
    </select>
  </div>
  <div class="card">
    <div>Odhad prÅ¯toku</div>
    <div class="value" id="flow">â€“</div>
    <div class="unit">l/h</div>
  </div>
  <div class="card">
    <div>OkamÅ¾itÃ½ vÃ½kon topenÃ­</div>
    <div class="value" id="powerHeat">â€“</div>
    <div class="unit">kW</div>
  </div>
</div>

<!-- SPOTREBA -->
<div class="section grid">
  <div class="card">
    <div>DennÃ­ energie â€“ topenÃ­</div>
    <div class="value" id="dayHeat">0.0</div>
    <div class="unit">kWh</div>
  </div>
  <div class="card">
    <div>MÄ›sÃ­ÄnÃ­ energie â€“ topenÃ­</div>
    <div class="value" id="monthHeat">0</div>
    <div class="unit">kWh</div>
  </div>
  <div class="card">
    <div>UhlÃ­ â€“ topenÃ­ (mÄ›sÃ­c)</div>
    <div class="value" id="coalHeat">0</div>
    <div class="unit">kg</div>
  </div>
</div>

<!-- GRAF -->
<div class="section card">
  <h3>ğŸ“ˆ Teploty â€“ poslednÃ­ch 24 h</h3>
  <canvas id="chart"></canvas>
</div>

<script>
const CHANNEL_ID = 231269;
const RESULTS = 96;
const COAL_PER_KWH = 0.27;

let lastTime = null;
let dailyHeat = 0;
let monthlyHeat = 0;
let chart = null;

const chartEl = document.getElementById('chart');

function flowFromPump(power, mode) {
  if (!power) return 0;
  let factor = 1;
  if (mode === 'cp') factor = 0.9;
  if (mode === 'cs') factor = 1.1;
  return power * 60 * factor;
}

pumpPower.value = localStorage.getItem('pumpPower') || 15;
pumpMode.value = localStorage.getItem('pumpMode') || 'auto';
pumpPower.onchange = () => localStorage.setItem('pumpPower', pumpPower.value);
pumpMode.onchange = () => localStorage.setItem('pumpMode', pumpMode.value);

async function loadData() {
  const res = await fetch(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=${RESULTS}`);
  const data = await res.json();
  const feeds = data.feeds;
  if (!feeds.length) return;

  const last = feeds.at(-1);
  const time = new Date(last.created_at);

  document.getElementById('lastUpdate').textContent =
    time.toLocaleString('cs-CZ');

  function val(n) {
    const v = parseFloat(last[`field${n}`]);
    return isNaN(v) ? null : v;
  }

  const f1 = val(1), f2 = val(2), f3 = val(3), f4 = val(4), f5 = val(5);
  if (f1==null || f2==null) return;

  document.getElementById('f1').textContent = f1.toFixed(1);
  document.getElementById('f2').textContent = f2.toFixed(1);
  if (f3!=null) document.getElementById('f3').textContent = f3.toFixed(1);
  if (f4!=null) document.getElementById('f4').textContent = f4.toFixed(1);
  if (f5!=null) document.getElementById('f5').textContent = f5.toFixed(1);

  const dt = f2 - f1;
  document.getElementById('dt').textContent = dt.toFixed(1);

  const flow = flowFromPump(+pumpPower.value, pumpMode.value);
  document.getElementById('flow').textContent = Math.round(flow);

  const powerHeat = 0.00116 * flow * dt;
  document.getElementById('powerHeat').textContent = powerHeat.toFixed(1);

  if (lastTime) {
    const hours = (time - lastTime) / 3600000;
    if (hours > 0 && hours < 1) {
      dailyHeat += powerHeat * hours;
      monthlyHeat += powerHeat * hours;
    }
  }
  lastTime = time;

  document.getElementById('dayHeat').textContent = dailyHeat.toFixed(1);
  document.getElementById('monthHeat').textContent = monthlyHeat.toFixed(0);
  document.getElementById('coalHeat').textContent =
    (monthlyHeat * COAL_PER_KWH).toFixed(0);

  drawChart(feeds);
}

function drawChart(feeds) {
  const labels = feeds.map(f =>
    new Date(f.created_at).toLocaleTimeString('cs-CZ',{hour:'2-digit',minute:'2-digit'}));

  const datasets = [
    {label:'VÃ½stup', field:'field2'},
    {label:'ZpÃ¡teÄka', field:'field1'},
    {label:'TUV', field:'field3'}
  ].map(c => ({
    label:c.label,
    data:feeds.map(f => f[c.field]),
    borderWidth:2,
    tension:0.3
  }));

  if (chart) chart.destroy();
  chart = new Chart(chartEl, {
    type:'line',
    data:{labels,datasets},
    options:{
      plugins:{legend:{labels:{color:'#e5e7eb'}}},
      scales:{
        x:{ticks:{color:'#94a3b8'}},
        y:{ticks:{color:'#94a3b8'}}
      }
    }
  });
}

loadData();
setInterval(loadData,60000);
</script>

</body>
</html>
