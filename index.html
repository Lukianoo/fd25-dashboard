<script>
const CHANNEL = 231269;
const ENERGY = 4.8; // kWh / kg uhlí
const EFF = 0.75;

kg10min.value = localStorage.kg10min || 2.5;
priceKg.value = localStorage.priceKg || 6.2;

function updateClock(){
  clock.textContent = new Date().toLocaleString("cs-CZ");
}

function secToKg(sec){
  return Math.max(0, (sec/600)*(+kg10min.value||2.5));
}

function todayStartISO(){
  const d=new Date();
  d.setHours(0,0,0,0);
  return d.toISOString();
}

function monthStartISO(){
  const d=new Date();
  d.setDate(1);
  d.setHours(0,0,0,0);
  return d.toISOString();
}

async function fetchFeeds(p){
  try{
    const r=await fetch(
      `https://api.thingspeak.com/channels/${CHANNEL}/feeds.json?${p}`
    );
    return (await r.json()).feeds || [];
  }catch(e){
    console.warn("ThingSpeak chyba",e);
    return [];
  }
}

/* ========= AKTUÁLNÍ DATA ========= */
async function updateCurrent(){
  const cur=await fetchFeeds("results=1");
  if(!cur.length) return;
  const f=cur[0];

  const tK=+f.field5||0;
  const tZ=+f.field1||0;

  tKotel.textContent=tK.toFixed(1)+" °C";
  tZpet.textContent=tZ.toFixed(1)+" °C";
  tPodavac.textContent=(+f.field2||0).toFixed(1)+" °C";
  tBojler.textContent=(+f.field3||0).toFixed(1)+" °C";
  tVenku.textContent=(+f.field4||0).toFixed(1)+" °C";

  deltaT.textContent=(tK-tZ).toFixed(1)+" °C";
  feedTotal.textContent=(+f.field8||0)+" s";
}

/* ========= HODINA ========= */
async function updateHour(){
  const feeds=await fetchFeeds("minutes=60&results=120");
  if(feeds.length<2) return;

  const sec=secToKg(
    feeds.at(-1).field8 - feeds[0].field8
  );

  const kg=sec;
  kgHour.textContent=kg.toFixed(2)+" kg";

  const kWh = kg * ENERGY * EFF;
  powerKWbig.textContent = kWh.toFixed(1)+" kWh";
}

/* ========= DEN ========= */
async function updateDay(){
  const feeds=await fetchFeeds(
    "start="+todayStartISO()+"&results=2000"
  );
  if(feeds.length<2) return;

  const kg=secToKg(
    feeds.at(-1).field8 - feeds[0].field8
  );

  kgDay.textContent=kg.toFixed(2)+" kg";
  costDay.textContent=(kg*(+priceKg.value||6.2)).toFixed(0)+" Kč";
}

/* ========= MĚSÍC ========= */
async function updateMonth(){
  const feeds=await fetchFeeds(
    "start="+monthStartISO()+"&results=3000"
  );
  if(feeds.length<2) return;

  const kg=secToKg(
    feeds.at(-1).field8 - feeds[0].field8
  );

  kgMonth.textContent=kg.toFixed(0)+" kg";
  costMonth.textContent=(kg*(+priceKg.value||6.2)).toFixed(0)+" Kč";
}

/* ========= HISTORIE ========= */
historyBtn.onclick = async () => {
  historyBox.style.display =
    historyBox.style.display === "none" ? "block" : "none";

  historyTable.innerHTML="";
  const days=14;
  const price=+priceKg.value||6.2;

  for(let i=0;i<days;i++){
    const d1=new Date();
    d1.setDate(d1.getDate()-i);
    d1.setHours(0,0,0,0);
    const d2=new Date(d1);
    d2.setDate(d2.getDate()+1);

    const feeds=await fetchFeeds(
      `start=${d1.toISOString()}&end=${d2.toISOString()}&results=2000`
    );

    if(feeds.length>1){
      const kg=secToKg(
        feeds.at(-1).field8 - feeds[0].field8
      );

      historyTable.innerHTML+=`
        <tr>
          <td>${d1.toLocaleDateString("cs-CZ")}</td>
          <td>${kg.toFixed(2)}</td>
          <td>${(kg*price).toFixed(0)}</td>
        </tr>`;
    }
  }
};

/* ========= ULOŽENÍ NASTAVENÍ ========= */
kg10min.oninput=()=>{
  localStorage.kg10min=kg10min.value;
  updateHour();updateDay();updateMonth();
};
priceKg.oninput=()=>{
  localStorage.priceKg=priceKg.value;
  updateDay();updateMonth();
};

/* ========= TIMERY ========= */
updateClock();
updateCurrent();
updateHour();
updateDay();
updateMonth();

setInterval(updateClock,1000);
setInterval(updateCurrent,30000);     // jen aktuální
setInterval(updateHour,300000);       // 5 min
setInterval(updateDay,900000);        // 15 min
setInterval(updateMonth,1800000);     // 30 min
</script>
