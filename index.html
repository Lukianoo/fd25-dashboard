<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8" />
<title>Attack FD25 ‚Äì P≈ôehled TUV</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
  margin: 0;
  padding: 20px;
}
h1 { margin-bottom: 5px; }
.update { opacity: 0.8; margin-bottom: 20px; }

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 16px;
}

.card {
  background: #020617;
  border-radius: 14px;
  padding: 14px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.4);
  text-align: center;
}

.value { font-size: 2rem; font-weight: bold; }
.unit { opacity: 0.7; }

canvas { margin-top: 10px; }
</style>
</head>

<body>

<h1>üî• Attack FD25 ‚Äì TUV monitoring</h1>
<div class="update" id="updated">Posledn√≠ aktualizace: ‚Äì</div>

<div class="grid">
  <div class="card"><div>TUV</div><div class="value" id="tuv">‚Äì</div><div class="unit">¬∞C</div></div>

  <div class="card"><div>Denn√≠ energie TUV</div><div class="value" id="day_kwh">‚Äì</div><div class="unit">kWh</div></div>
  <div class="card"><div>Denn√≠ spot≈ôeba uhl√≠</div><div class="value" id="day_coal">‚Äì</div><div class="unit">kg</div></div>

  <div class="card"><div>Mƒõs√≠ƒçn√≠ energie TUV</div><div class="value" id="month_kwh">‚Äì</div><div class="unit">kWh</div></div>
  <div class="card"><div>Mƒõs√≠ƒçn√≠ spot≈ôeba uhl√≠</div><div class="value" id="month_coal">‚Äì</div><div class="unit">kg</div></div>
</div>

<div class="card" style="margin-top:25px;">
  <h3>üìà Teploty ‚Äì posledn√≠ch 24 h</h3>
  <canvas id="chart"></canvas>
</div>

<script>
const CHANNEL_ID = 231269;
const RESULTS = 96; // 24 h (15 min)

const BOJLER_KG = 125;
const CP = 4.186;
const ETA = 0.75;
const COAL_KWH_KG = 5.0;

let chart;

function energyFromDelta(dT) {
  return BOJLER_KG * CP * dT / 3600 / ETA;
}

async function loadData() {
  const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=${RESULTS}`;
  const res = await fetch(url);
  const data = await res.json();
  const feeds = data.feeds;

  const last = feeds[feeds.length - 1];
  document.getElementById('updated').textContent =
    'Posledn√≠ aktualizace: ' +
    new Date(last.created_at).toLocaleString('cs-CZ');

  document.getElementById('tuv').textContent =
    Number(last.field3).toFixed(1);

  let dayKwh = 0;
  let monthKwh = 0;

  for (let i = 1; i < feeds.length; i++) {
    const prev = Number(feeds[i - 1].field3);
    const curr = Number(feeds[i].field3);
    if (isNaN(prev) || isNaN(curr)) continue;

    const delta = curr - prev;
    if (delta > 0) {
      const e = energyFromDelta(delta);
      dayKwh += e;
      monthKwh += e; // zat√≠m posledn√≠ch 24 h = mƒõs√≠c ≈ôe≈°√≠me zvl√°≈°≈•
    }
  }

  document.getElementById('day_kwh').textContent = dayKwh.toFixed(2);
  document.getElementById('day_coal').textContent = (dayKwh / COAL_KWH_KG).toFixed(2);
  document.getElementById('month_kwh').textContent = monthKwh.toFixed(2);
  document.getElementById('month_coal').textContent = (monthKwh / COAL_KWH_KG).toFixed(2);

  const labels = feeds.map(f =>
    new Date(f.created_at).toLocaleTimeString('cs-CZ', {hour:'2-digit', minute:'2-digit'})
  );

  const datasets = [
    { label: 'V√Ωstup', field: 'field2' },
    { label: 'Zp√°teƒçka', field: 'field1' },
    { label: 'TUV', field: 'field3' }
  ].map(cfg => ({
    label: cfg.label,
    data: feeds.map(f => f[cfg.field]),
    borderWidth: 2,
    tension: 0.3
  }));

  if (chart) chart.destroy();
  chart = new Chart(document.getElementById('chart'), {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      plugins: { legend: { labels: { color: '#e5e7eb' } } },
      scales: {
        x: { ticks: { color: '#94a3b8' } },
        y: { ticks: { color: '#94a3b8' } }
      }
    }
  });
}

loadData();
setInterval(loadData, 60000);
</script>

</body>
</html>
