<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8">
<title>Kotelna â€“ Attack FD 25</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Segoe UI,system-ui;
  background:linear-gradient(135deg,#0db8b2,#076360);
  color:#222;
}
header{
  background:#000;
  color:#fff;
  padding:15px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
}
main{max-width:1400px;margin:auto;padding:20px}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
}
.card{
  background:#fff;
  border-radius:14px;
  padding:20px;
  box-shadow:0 10px 30px rgba(0,0,0,.25);
}
h2{margin:0 0 10px;font-size:16px;color:#1e3c72}
.value{font-size:32px;font-weight:700;color:#d32f2f}
.sub{font-size:13px;color:#555}
.green{color:#2e7d32}
.blue{color:#1565c0}
.orange{color:#ef6c00}
input{width:100%;padding:10px;font-size:15px}
.settings{display:grid;grid-template-columns:1fr 1fr;gap:15px}
button{
  padding:12px 18px;
  font-size:15px;
  border-radius:10px;
  border:none;
  color:#fff;
  cursor:pointer;
  width:100%;
  margin-bottom:10px;
  box-sizing:border-box;
}
#historyBtn     { background:#ef6c00; }
#monthHistoryBtn { background:#1565c0; }
#totalHistoryBtn { background:#2e7d32; }
button:hover { opacity:0.88; }
table{width:100%;border-collapse:collapse}
th,td{padding:9px 6px;text-align:center}
th{background:#f5f5f5}
footer{text-align:center;margin:40px 0 20px;opacity:0.85}
footer img{
  max-width:400px;
  width:100%;
  transition:.3s;
  filter:drop-shadow(0 4px 8px rgba(0,0,0,.4));
}
footer img:hover{transform:scale(1.03)}
@media (max-width:600px){
  header{flex-direction:column;align-items:flex-start;padding:10px 15px}
  main{padding:10px}
  .card{padding:15px}
  h2{font-size:14px}
  .value{font-size:24px}
  .sub{font-size:12px}
  .settings{grid-template-columns:1fr}
  .grid{grid-template-columns:repeat(auto-fit,minmax(150px,1fr))}
  table{display:block;overflow-x:auto;white-space:nowrap}
}
</style>
</head>
<body>

<header>
  <div id="clock" style="font-size:25px;min-width:180px"></div>
  <div style="flex:1;text-align:center;font-size:25px;font-weight:700">
    ATTACK FD 25 AUTOMAT â€“ PANEL KOTELNY ZACHRÄŒ
  </div>
  <button id="fullscreenBtn" style="padding:6px 12px;font-size:14px;border-radius:8px;background:#6a1b9a;border:none;cursor:pointer;">
    â›¶ Fullscreen
  </button>
</header>

<main>

<div class="grid">
  <div class="card"><h2>ğŸ”¥ Kotel</h2><div class="value" id="tKotel">--</div></div>
  <div class="card"><h2>â†©ï¸ ZpÃ¡teÄka</h2><div class="value blue" id="tZpet">--</div></div>
  <div class="card"><h2>ğŸŒ¡ï¸ TeplotnÃ­ spÃ¡d Î”T</h2><div class="value orange" id="deltaT">--</div></div>
  <div class="card"><h2>âš¡ AktuÃ¡lnÃ­ vÃ½kon</h2><div class="value green" id="powerKWbig">--</div></div>
  <div class="card"><h2>âš™ï¸ PodavaÄ</h2><div class="value" id="tPodavac">--</div></div>
  <div class="card"><h2>ğŸ’§ Bojler</h2><div class="value" id="tBojler">--</div></div>
  <div class="card"><h2>ğŸŒ¡ï¸ Venku</h2><div class="value" id="tVenku">--</div></div>
  <div class="card"><h2>â±ï¸ PodavaÄ celkem</h2><div class="value" id="feedTotal">--</div></div>
</div>

<br>

<div class="card">
  <h2>ğŸ’° SpotÅ™eba uhlÃ­</h2>
  <div class="grid">
    <div><div class="sub">HODINA</div><div class="value orange" id="kgHour">â€” kg</div></div>
    <div><div class="sub">DNES</div><div class="value green" id="kgDay">naÄÃ­tÃ¡m...</div></div>
    <div><div class="sub">MÄšSÃC</div><div class="value blue" id="kgMonth">naÄÃ­tÃ¡m...</div></div>
    <div><div class="sub">CENA DNES</div><div class="value" id="costDay">â€” KÄ</div></div>
    <div><div class="sub">CENA MÄšSÃC</div><div class="value" id="costMonth">â€” KÄ</div></div>
  </div>
  <br>
  <button id="historyBtn">ğŸ“… DennÃ­ historie spotÅ™eby</button>
  <button id="monthHistoryBtn">ğŸ“† MÄ›sÃ­ÄnÃ­ historie spotÅ™eby</button>
  <button id="totalHistoryBtn">ğŸ“ˆ CelkovÃ¡ historie spotÅ™eby</button>
</div>

<div id="historyBox" class="card" style="display:none;margin-top:20px">
  <h2>ğŸ“Š DennÃ­ historie â€“ uhlÃ­ & cena</h2>
  <table><thead><tr><th>Datum</th><th>SpotÅ™eba (kg)</th><th>Cena (KÄ)</th></tr></thead><tbody id="historyTable"></tbody></table>
</div>

<div id="monthHistoryBox" class="card" style="display:none;margin-top:20px">
  <h2>ğŸ“† MÄ›sÃ­ÄnÃ­ historie â€“ uhlÃ­ & cena</h2>
  <table><thead><tr><th>MÄ›sÃ­c</th><th>SpotÅ™eba (kg)</th><th>Cena (KÄ)</th></tr></thead><tbody id="monthHistoryTable"></tbody></table>
</div>

<div id="totalHistoryBox" class="card" style="display:none;margin-top:20px">
  <h2>ğŸ“ˆ CelkovÃ¡ historie â€“ od zaÄÃ¡tku mÄ›Å™enÃ­</h2>
  <table><thead><tr><th>ObdobÃ­</th><th>SpotÅ™eba (kg)</th><th>Cena (KÄ)</th></tr></thead><tbody id="totalHistoryTable"></tbody></table>
</div>

<br>

<div class="card">
  <h2>âš™ï¸ NastavenÃ­</h2>
  <div class="settings">
    <div>
      <label>Kg uhlÃ­ / 10 min</label>
      <input type="number" id="kg10min" step="0.1" min="0.1">
    </div>
    <div>
      <label>Cena / kg</label>
      <input type="number" id="priceKg" step="0.1" min="0">
    </div>
  </div>
</div>

</main>

<script>
const CHANNEL       = 231269;
const DAY_CHANNEL   = 3238281;
const ENERGY        = 4.8;
const EFF           = 0.75;

const kg10minInput  = document.getElementById('kg10min');
const priceKgInput  = document.getElementById('priceKg');
kg10minInput.value  = localStorage.kg10min || 2.5;
priceKgInput.value  = localStorage.priceKg || 6.2;

const elements = {
  clock:      document.getElementById('clock'),
  tKotel:     document.getElementById('tKotel'),
  tZpet:      document.getElementById('tZpet'),
  deltaT:     document.getElementById('deltaT'),
  powerKWbig: document.getElementById('powerKWbig'),
  tPodavac:   document.getElementById('tPodavac'),
  tBojler:    document.getElementById('tBojler'),
  tVenku:     document.getElementById('tVenku'),
  feedTotal:  document.getElementById('feedTotal'),
  kgHour:     document.getElementById('kgHour'),
  kgDay:      document.getElementById('kgDay'),
  kgMonth:    document.getElementById('kgMonth'),
  costDay:    document.getElementById('costDay'),
  costMonth:  document.getElementById('costMonth'),
};

async function fetchFeeds(params) {
  try {
    const r = await fetch(`https://api.thingspeak.com/channels/${CHANNEL}/feeds.json?${params}`);
    if (!r.ok) throw new Error(r.status);
    const d = await r.json();
    return d.feeds || [];
  } catch (e) {
    console.error("fetchFeeds error:", e);
    return [];
  }
}

async function fetchDayFeeds(params) {
  try {
    const r = await fetch(`https://api.thingspeak.com/channels/${DAY_CHANNEL}/feeds.json?${params}`);
    if (!r.ok) throw new Error(r.status);
    const d = await r.json();
    return d.feeds || [];
  } catch (e) {
    console.error("fetchDayFeeds error:", e);
    return [];
  }
}

function secToHMS(s) {
  s = Math.max(0, Math.floor(Number(s)||0));
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  const sec = s%60;
  return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
}

function secToKg(sec) {
  return Math.max(0, (Number(sec)||0) / 600 * (Number(kg10minInput.value)||2.5));
}

function safeSecDiff(a,b) {
  const d = Number(a) - Number(b);
  return d > 0 ? d : 0;
}

function todayStartISO() {
  const d = new Date();
  d.setHours(0,0,0,0);
  return d.toISOString().slice(0,19);
}

function fmt(v) {
  const n = Number(v);
  return Number.isFinite(n) ? n.toFixed(1) : '--';
}

async function updateCurrent() {
  const f = (await fetchFeeds('results=1'))[0];
  if (!f) return;

  const tk = Number(f.field5);
  const tz = Number(f.field1);

  elements.tKotel.textContent    = fmt(tk) + ' Â°C';
  elements.tZpet.textContent     = fmt(tz) + ' Â°C';
  elements.deltaT.textContent    = fmt(tk - tz) + ' Â°C';
  elements.tPodavac.textContent  = fmt(f.field2) + ' Â°C';
  elements.tBojler.textContent   = fmt(f.field3) + ' Â°C';
  elements.tVenku.textContent    = fmt(f.field4) + ' Â°C';
  elements.feedTotal.textContent = secToHMS(f.field8);
}

async function updateHour() {
  const f = await fetchFeeds('minutes=60&results=120');
  if (f.length < 2) {
    elements.kgHour.textContent = 'â€” kg';
    elements.powerKWbig.textContent = 'â€” kWh';
    return;
  }
  const sec = safeSecDiff(f.at(-1).field8, f[0].field8);
  const kg = secToKg(sec);
  elements.kgHour.textContent = kg.toFixed(2) + ' kg';
  elements.powerKWbig.textContent = (kg * ENERGY * EFF).toFixed(1) + ' kWh';
}

async function updateDay() {
  elements.kgDay.textContent = 'naÄÃ­tÃ¡m...';
  elements.costDay.textContent = 'naÄÃ­tÃ¡m...';

  const start = todayStartISO();
  const end   = new Date().toISOString().slice(0,19);
  const feeds = await fetchFeeds(`start=${start}&end=${end}&results=300`);

  let kg = 0;
  if (feeds.length >= 2) {
    const sec = safeSecDiff(feeds.at(-1).field8, feeds[0].field8);
    kg = secToKg(sec);
  }

  const price = Number(priceKgInput.value) || 6.2;
  elements.kgDay.textContent   = kg.toFixed(0) + ' kg';
  elements.costDay.textContent = (kg * price).toFixed(0) + ' KÄ';
}

async function updateMonth() {
  elements.kgMonth.textContent = 'naÄÃ­tÃ¡m...';
  elements.costMonth.textContent = 'naÄÃ­tÃ¡m...';

  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth() + 1).padStart(2,'0');
  const monthStart = `${y}-${m}-01T00:00:00`;

  let kg = 0;
  const daily = await fetchDayFeeds(`start=${monthStart}&results=400`);
  kg = daily.reduce((sum,d)=>sum + (Number(d.field1)||0), 0);

  // + dneÅ¡ek
  const todayFeeds = await fetchFeeds(`start=${todayStartISO()}&results=300`);
  if (todayFeeds.length >= 2) {
    const sec = safeSecDiff(todayFeeds.at(-1).field8, todayFeeds[0].field8);
    kg += secToKg(sec);
  }

  const price = Number(priceKgInput.value) || 6.2;
  elements.kgMonth.textContent   = kg.toFixed(0) + ' kg';
  elements.costMonth.textContent = (kg * price).toFixed(0) + ' KÄ';
}

document.getElementById('historyBtn').onclick = async () => {
  const box = document.getElementById('historyBox');
  const visible = box.style.display !== 'none';
  box.style.display = visible ? 'none' : 'block';
  if (visible) return;

  const tbody = document.getElementById('historyTable');
  tbody.innerHTML = '<tr><td colspan="3">naÄÃ­tÃ¡m...</td></tr>';

  const price = Number(priceKgInput.value) || 6.2;
  const feeds = await fetchDayFeeds('results=31');
  const map = {};
  feeds.forEach(d => {
    const day = new Date(d.created_at).toLocaleDateString('cs-CZ');
    map[day] = (map[day] || 0) + (Number(d.field1)||0);
  });

  tbody.innerHTML = Object.entries(map)
    .sort(([a],[b]) => new Date(b) - new Date(a))
    .map(([day,kg]) => `<tr><td>${day}</td><td>${kg.toFixed(0)}</td><td>${(kg*price).toFixed(0)}</td></tr>`)
    .join('');
};

document.getElementById('monthHistoryBtn').onclick = async () => {
  const box = document.getElementById('monthHistoryBox');
  const visible = box.style.display !== 'none';
  box.style.display = visible ? 'none' : 'block';
  if (visible) return;

  const tbody = document.getElementById('monthHistoryTable');
  tbody.innerHTML = '<tr><td colspan="3">naÄÃ­tÃ¡m...</td></tr>';

  const price = Number(priceKgInput.value) || 6.2;
  const now = new Date();
  const start = new Date(now.getFullYear(), now.getMonth() - 14, 1).toISOString().slice(0,19);

  const feeds = await fetchDayFeeds(`start=${start}&results=500`);
  const months = {};

  feeds.forEach(d => {
    const dt = new Date(d.created_at);
    const key = `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}`;
    months[key] = (months[key] || 0) + (Number(d.field1)||0);
  });

  // aktuÃ¡lnÃ­ mÄ›sÃ­c + dneÅ¡ek
  const curKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
  if (!(curKey in months)) months[curKey] = 0;

  const todayStart = todayStartISO();
  const todayF = await fetchFeeds(`start=${todayStart}&results=300`);
  if (todayF.length >= 2) {
    const sec = safeSecDiff(todayF.at(-1).field8, todayF[0].field8);
    months[curKey] += secToKg(sec);
  }

  tbody.innerHTML = Object.entries(months)
    .sort(([a],[b]) => b.localeCompare(a))
    .slice(0,12)
    .map(([key,kg]) => {
      const [y,m] = key.split('-');
      const date = new Date(y, m-1);
      const name = date.toLocaleDateString('cs-CZ', {month:'long', year:'numeric'});
      return `<tr><td>${name}</td><td>${kg.toFixed(0)}</td><td>${(kg*price).toFixed(0)}</td></tr>`;
    })
    .join('') || '<tr><td colspan="3">Å½Ã¡dnÃ¡ data</td></tr>';
};

document.getElementById('totalHistoryBtn').onclick = async () => {
  const box = document.getElementById('totalHistoryBox');
  const visible = box.style.display !== 'none';
  box.style.display = visible ? 'none' : 'block';
  if (visible) return;

  const tbody = document.getElementById('totalHistoryTable');
  tbody.innerHTML = '<tr><td colspan="3">naÄÃ­tÃ¡m...</td></tr>';

  const price = Number(priceKgInput.value) || 6.2;
  const all = await fetchDayFeeds('results=8000');

  let totalKg = all.reduce((s,d)=>s + (Number(d.field1)||0), 0);
  let first = all.length ? new Date(all.at(-1).created_at) : null;
  let last  = all.length ? new Date(all[0].created_at)  : null;

  // + dneÅ¡ek
  const ts = todayStartISO();
  const tf = await fetchFeeds(`start=${ts}&results=300`);
  if (tf.length >= 2) {
    const sec = safeSecDiff(tf.at(-1).field8, tf[0].field8);
    totalKg += secToKg(sec);
    if (!last || new Date(tf[0].created_at) > last) last = new Date();
  }

  const period = first && last
    ? `${first.toLocaleDateString('cs-CZ')} â€“ ${last.toLocaleDateString('cs-CZ')}`
    : 'Å½Ã¡dnÃ¡ data';

  tbody.innerHTML = `<tr><td>${period}</td><td>${totalKg.toFixed(0)}</td><td>${(totalKg*price).toFixed(0)}</td></tr>`;
};

kg10minInput.oninput = () => { localStorage.kg10min = kg10minInput.value; updateHour(); updateDay(); };
priceKgInput.oninput = () => { localStorage.priceKg = priceKgInput.value; updateDay(); updateMonth(); };

document.getElementById('fullscreenBtn').onclick = () => {
  const e = document.documentElement;
  if (!document.fullscreenElement) {
    e.requestFullscreen?.() || e.webkitRequestFullscreen?.();
  } else {
    document.exitFullscreen?.() || document.webkitExitFullscreen?.();
  }
};

// inicializace
elements.clock.textContent = new Date().toLocaleString('cs-CZ');
updateCurrent();
updateHour();
updateDay();
updateMonth();

setInterval(()=>{ elements.clock.textContent = new Date().toLocaleString('cs-CZ'); }, 10000);
setInterval(updateCurrent, 30000);
setInterval(updateHour,   300000);
setInterval(updateDay,     60000);
setInterval(updateMonth,  600000);
</script>

<footer>
  <img src="https://raw.githubusercontent.com/Lukianoo/fd25-dashboard/main/logo-elektroservis.png" alt="Elektroservis logo">
</footer>

</body>
</html>
