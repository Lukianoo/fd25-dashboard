<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8" />
<title>Attack FD25 â€“ PÅ™ehled teplot</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
  margin: 0;
  padding: 20px;
}
h1 {
  font-size: 1.8rem;
  margin-bottom: 20px;
}
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 20px;
}
.card {
  background: #020617;
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.4);
  text-align: center;
}
.value {
  font-size: 2.2rem;
  font-weight: bold;
}
.unit {
  font-size: 1rem;
  opacity: 0.7;
}
canvas {
  margin-top: 10px;
}
</style>
</head>

<body>

<h1>ğŸ”¥ Attack FD25 â€“ RodinnÃ½ dÅ¯m</h1>
<p>AutomatickÃ½ kotel FD25 + bojler 125 l</p>

<div class="grid">
  <div class="card"><div>Kotel</div><div class="value" id="f5">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div>VÃ½stup z kotle</div><div class="value" id="f2">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div>ZpÃ¡teÄka kotle</div><div class="value" id="f1">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div>Teplota TUV</div><div class="value" id="f3">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div>VenkovnÃ­ teplota</div><div class="value" id="f4">â€“</div><div class="unit">Â°C</div></div>
</div>

<div class="card" style="margin-top:30px;">
  <h2>ğŸ“ˆ Historie teplot (24 h)</h2>
  <canvas id="chart"></canvas>
</div>

<script>
const CHANNEL_ID = 231269;
const RESULTS = 96;
let chart;

// Plugin pro popisky na konci kÅ™ivek
const lineLabelsPlugin = {
  id: 'lineLabels',
  afterDatasetsDraw(chart) {
    const { ctx } = chart;
    ctx.save();
    chart.data.datasets.forEach((dataset, i) => {
      const meta = chart.getDatasetMeta(i);
      if (!meta.hidden) {
        const lastPoint = meta.data[meta.data.length - 1];
        const value = dataset.data[dataset.data.length - 1];
        if (value !== null) {
          ctx.fillStyle = dataset.borderColor || '#fff';
          ctx.font = '12px Arial';
          ctx.fillText(
            `${dataset.label}: ${Number(value).toFixed(1)}Â°C`,
            lastPoint.x + 6,
            lastPoint.y + 4
          );
        }
      }
    });
    ctx.restore();
  }
};

async function loadData() {
  const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=${RESULTS}`;
  const res = await fetch(url);
  const data = await res.json();
  const feeds = data.feeds;

  const last = feeds[feeds.length - 1];

  // KARTY â€“ 1 desetinnÃ© mÃ­sto
  for (let i = 1; i <= 5; i++) {
    const val = last[`field${i}`];
    document.getElementById(`f${i}`).textContent =
      val !== null ? Number(val).toFixed(1) : 'â€“';
  }

  const labels = feeds.map(f =>
    new Date(f.created_at).toLocaleTimeString('cs-CZ', {
      hour: '2-digit',
      minute: '2-digit'
    })
  );

  const datasets = [
    { label: 'Kotel', field: 'field5' },
    { label: 'VÃ½stup z kotle', field: 'field2' },
    { label: 'ZpÃ¡teÄka kotle', field: 'field1' },
    { label: 'TUV', field: 'field3' },
    { label: 'VenkovnÃ­ teplota', field: 'field4' }
  ].map(cfg => ({
    label: cfg.label,
    data: feeds.map(f =>
      f[cfg.field] !== null ? Number(f[cfg.field]).toFixed(1) : null
    ),
    borderWidth: 2,
    tension: 0.3
  }));

  if (chart) chart.destroy();

  chart = new Chart(document.getElementById('chart'), {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      plugins: {
        legend: {
          labels: { color: '#e5e7eb' }
        }
      },
      scales: {
        x: { ticks: { color: '#94a3b8' } },
        y: { ticks: { color: '#94a3b8' } }
      }
    },
    plugins: [lineLabelsPlugin]
  });
}

loadData();
setInterval(loadData, 60000);
</script>

</body>
</html>
