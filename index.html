<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Kotelna – Profi panel</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
    font-family: Arial, sans-serif;
    background:#f4f6f8;
    margin:0;
}
header {
    background:#1f2937;
    color:white;
    padding:15px;
    text-align:center;
}
.container {
    padding:20px;
    max-width:1200px;
    margin:auto;
}
.grid {
    display:grid;
    grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
    gap:15px;
}
.card {
    background:white;
    padding:15px;
    border-radius:8px;
    box-shadow:0 2px 5px rgba(0,0,0,0.1);
}
.card h3 {
    margin-top:0;
    font-size:16px;
    color:#374151;
}
.value {
    font-size:26px;
    font-weight:bold;
}
.settings input {
    width:100%;
    padding:6px;
    margin-top:5px;
}
footer {
    text-align:center;
    margin-top:20px;
    color:#555;
}
canvas {
    background:white;
    border-radius:8px;
    padding:10px;
}
</style>
</head>

<body>
<header>
    <h1>Kotelna – Attack FD 25 Automat</h1>
    <div id="datetime"></div>
    <div id="lastUpdate"></div>
</header>

<div class="container">

<!-- TEPLOTY -->
<div class="grid">
    <div class="card"><h3>Teplota kotle</h3><div class="value" id="t_kotel">-- °C</div></div>
    <div class="card"><h3>TUV (bojler)</h3><div class="value" id="t_bojler">-- °C</div></div>
    <div class="card"><h3>Venkovní</h3><div class="value" id="t_venku">-- °C</div></div>
    <div class="card"><h3>Zpátečka</h3><div class="value" id="t_zpatecka">-- °C</div></div>
    <div class="card"><h3>Podavač</h3><div class="value" id="t_podavac">-- °C</div></div>
    <div class="card"><h3>Aktuální výkon</h3><div class="value" id="vykon">-- kW</div></div>
</div>

<br>

<!-- SPOTŘEBA -->
<div class="grid">
    <div class="card settings">
        <h3>Nastavení</h3>
        Kg uhlí / 10 min:
        <input type="number" id="kg10" value="1.5" step="0.1">
        Cena uhlí (Kč/kg):
        <input type="number" id="cena" value="6" step="0.1">
    </div>

    <div class="card">
        <h3>Spotřeba</h3>
        <b id="spotDen">-- kg / den</b><br>
        <b id="spotMes">-- kg / měsíc</b>
    </div>

    <div class="card">
        <h3>Náklady</h3>
        Den: <b id="nakDen">-- Kč</b><br>
        Měsíc: <b id="nakMes">-- Kč</b><br>
        Rok: <b id="nakRok">-- Kč</b>
    </div>
</div>

<br>

<!-- GRAF -->
<div class="card">
    <h3>Graf teplot – posledních 24 h</h3>
    <canvas id="chart24"></canvas>
</div>

</div>

<footer>
    Data: ThingSpeak | Profi kotelnový panel
</footer>

<script>
const CHANNEL = 231269;
const API = `https://api.thingspeak.com/channels/${CHANNEL}/feeds.json?results=288`;

function updateTime() {
    document.getElementById("datetime").innerText =
        new Date().toLocaleString("cs-CZ");
}
setInterval(updateTime,1000);
updateTime();

function fmt(val){
    return val !== null && val !== "" ? parseFloat(val).toFixed(1) : "--";
}

async function loadData() {
    const r = await fetch(API);
    const d = await r.json();
    const f = d.feeds;
    const last = f[f.length-1];

    document.getElementById("lastUpdate").innerText =
        "Poslední aktualizace: " + new Date(last.created_at).toLocaleString("cs-CZ");

    document.getElementById("t_kotel").innerText = fmt(last.field5)+" °C";
    document.getElementById("t_bojler").innerText = fmt(last.field3)+" °C";
    document.getElementById("t_venku").innerText = fmt(last.field4)+" °C";
    document.getElementById("t_zpatecka").innerText = fmt(last.field1)+" °C";
    document.getElementById("t_podavac").innerText = fmt(last.field2)+" °C";

    // SPOTŘEBA – field 8 v sekundách
    const feederNowSec = parseFloat(last.field8 || 0);
    const feederStartSec = parseFloat(f[0].field8 || 0);
    const diffMin = (feederNowSec - feederStartSec) / 60;

    const kg10 = parseFloat(document.getElementById("kg10").value);
    const kgPerMin = kg10 / 10;
    const spotKg = diffMin * kgPerMin;

    const startTime = new Date(f[0].created_at);
    const nowTime = new Date(last.created_at);
    const hoursMeasured = (nowTime - startTime) / 3600000;

    let spotDen = 0;
    if (hoursMeasured >= 1) {
        spotDen = (spotKg / hoursMeasured) * 24;
        document.getElementById("spotDen").innerText = spotDen.toFixed(1)+" kg / den";
        document.getElementById("spotMes").innerText = (spotDen*30).toFixed(0)+" kg / měsíc";
    } else {
        document.getElementById("spotDen").innerText = spotKg.toFixed(2)+" kg (zatím)";
        document.getElementById("spotMes").innerText = "–";
    }

    // NÁKLADY
    const cena = parseFloat(document.getElementById("cena").value);
    document.getElementById("nakDen").innerText = (spotDen*cena).toFixed(0);
    document.getElementById("nakMes").innerText = (spotDen*30*cena).toFixed(0);
    document.getElementById("nakRok").innerText = (spotDen*365*cena).toFixed(0);

    // VÝKON – poslední hodina
    const lastHour = f.slice(-12);
    const runSec = lastHour[lastHour.length-1].field8 - lastHour[0].field8;
    const runMin = runSec / 60;
    const power = Math.min(25, (runMin / 60) * 25);
    document.getElementById("vykon").innerText = power.toFixed(1)+" kW";

    drawChart(f);
}

let chart;
function drawChart(f){
    const labels = f.map(x => new Date(x.created_at).toLocaleTimeString("cs-CZ"));
    const kotel = f.map(x => x.field5);
    const zpatecka = f.map(x => x.field1);
    const tuv = f.map(x => x.field3);

    if(chart) chart.destroy();
    chart = new Chart(document.getElementById("chart24"),{
        type:"line",
        data:{
            labels,
            datasets:[
                { label:"Kotel", data:kotel, borderColor:"red", tension:0.3 },
                { label:"Zpátečka", data:zpatecka, borderColor:"blue", tension:0.3 },
                { label:"TUV", data:tuv, borderColor:"green", tension:0.3 }
            ]
        },
        options:{
            scales:{
                y:{ title:{ display:true, text:"°C" } }
            }
        }
    });
}

loadData();
setInterval(loadData,60000);
</script>

</body>
</html>
