<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Kotelna – Profi panel</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
    font-family: Arial, sans-serif;
    background:#f4f6f8;
    margin:0;
}
header {
    background:#1f2937;
    color:white;
    padding:15px;
    text-align:center;
}
.container {
    padding:20px;
    max-width:1200px;
    margin:auto;
}
.grid {
    display:grid;
    grid-template-columns: repeat(auto-fit,minmax(220px,1fr));
    gap:15px;
}
.card {
    background:white;
    padding:15px;
    border-radius:8px;
    box-shadow:0 2px 5px rgba(0,0,0,0.1);
}
.card h3 {
    margin-top:0;
    font-size:16px;
    color:#374151;
}
.value {
    font-size:28px;
    font-weight:bold;
}
.settings input {
    width:100%;
    padding:6px;
    margin-top:5px;
}
footer {
    text-align:center;
    margin-top:20px;
    color:#555;
}
canvas {
    background:white;
    border-radius:8px;
    padding:10px;
}
</style>
</head>

<body>
<header>
    <h1>Kotelna – Attack FD 25 Automat</h1>
    <div id="datetime"></div>
    <div id="lastUpdate"></div>
</header>

<div class="container">

<div class="grid">
    <div class="card"><h3>Teplota kotle</h3><div class="value" id="t_kotel">-- °C</div></div>
    <div class="card"><h3>Bojler</h3><div class="value" id="t_bojler">-- °C</div></div>
    <div class="card"><h3>Venkovní</h3><div class="value" id="t_venku">-- °C</div></div>
    <div class="card"><h3>Zpátečka</h3><div class="value" id="t_zpatecka">-- °C</div></div>
    <div class="card"><h3>Podavač</h3><div class="value" id="t_podavac">-- °C</div></div>
    <div class="card"><h3>Aktuální výkon</h3><div class="value" id="vykon">-- kW</div></div>
</div>

<br>

<div class="grid">
    <div class="card settings">
        <h3>Nastavení</h3>
        kg uhlí / 10 min:
        <input type="number" id="kg10" value="1.5" step="0.1">
        Cena uhlí (Kč/kg):
        <input type="number" id="cena" value="6" step="0.1">
    </div>

    <div class="card">
        <h3>Spotřeba 24h</h3>
        <div class="value" id="spot24">-- kg</div>
    </div>

    <div class="card">
        <h3>Spotřeba měsíc</h3>
        <div class="value" id="spotMes">-- kg</div>
    </div>

    <div class="card">
        <h3>Náklady</h3>
        Den: <b id="nakDen">-- Kč</b><br>
        Měsíc: <b id="nakMes">-- Kč</b><br>
        Rok: <b id="nakRok">-- Kč</b>
    </div>
</div>

<br>
<div class="card">
    <h3>Graf teplot – posledních 24h</h3>
    <canvas id="chart24"></canvas>
</div>

</div>

<footer>
    Data: ThingSpeak | Panel připraven pro GitHub Pages
</footer>

<script>
const CHANNEL = 231269;
const API = `https://api.thingspeak.com/channels/${CHANNEL}/feeds.json?results=288`;

function now() {
    document.getElementById("datetime").innerText =
        new Date().toLocaleString("cs-CZ");
}
setInterval(now,1000);
now();

async function loadData() {
    const r = await fetch(API);
    const d = await r.json();
    const f = d.feeds;

    const last = f[f.length-1];
    document.getElementById("lastUpdate").innerText =
        "Poslední aktualizace: " + new Date(last.created_at).toLocaleString("cs-CZ");

    t("t_kotel", last.field5);
    t("t_bojler", last.field3);
    t("t_venku", last.field4);
    t("t_zpatecka", last.field1);
    t("t_podavac", last.field2);

    const feederNow = parseFloat(last.field8 || 0);
    const feeder24 = parseFloat(f[0].field8 || 0);
    const diffMin = feederNow - feeder24;

    const kg10 = parseFloat(document.getElementById("kg10").value);
    const kgPerMin = kg10 / 10;
    const spot24 = diffMin * kgPerMin;

    document.getElementById("spot24").innerText = spot24.toFixed(1)+" kg";
    document.getElementById("spotMes").innerText = (spot24*30).toFixed(0)+" kg";

    const cena = parseFloat(document.getElementById("cena").value);
    document.getElementById("nakDen").innerText = (spot24*cena).toFixed(0);
    document.getElementById("nakMes").innerText = (spot24*30*cena).toFixed(0);
    document.getElementById("nakRok").innerText = (spot24*365*cena).toFixed(0);

    // výkon kotle (odhad)
    const lastHour = f.slice(-12);
    const runMin = lastHour[lastHour.length-1].field8 - lastHour[0].field8;
    const power = Math.min(25, (runMin/60)*25);
    document.getElementById("vykon").innerText = power.toFixed(1)+" kW";

    drawChart(f);
}

function t(id,val){
    document.getElementById(id).innerText = val ? val+" °C" : "--";
}

let chart;
function drawChart(f){
    const labels = f.map(x=>new Date(x.created_at).toLocaleTimeString("cs-CZ"));
    const dataKotel = f.map(x=>x.field5);
    if(chart) chart.destroy();
    chart = new Chart(document.getElementById("chart24"),{
        type:"line",
        data:{
            labels,
            datasets:[{
                label:"Teplota kotle",
                data:dataKotel,
                borderColor:"red",
                tension:0.3
            }]
        }
    });
}

loadData();
setInterval(loadData,60000);
</script>

</body>
</html>
