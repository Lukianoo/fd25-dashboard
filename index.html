<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Attack FD25 â€“ Profi panel vytÃ¡pÄ›nÃ­</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background:#0f172a;
  color:#e5e7eb;
  margin:0;
  padding:20px;
}
h1 { margin-bottom:4px; }
small { color:#94a3b8; }

.section { margin-top:24px; }

.grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:16px;
}

.card {
  background:#020617;
  border-radius:16px;
  padding:16px;
  box-shadow:0 10px 25px rgba(0,0,0,0.4);
}

.label {
  font-size:0.9rem;
  opacity:.8;
}

.value {
  font-size:2.1rem;
  font-weight:bold;
}

.unit {
  font-size:0.9rem;
  opacity:.7;
}

canvas { margin-top:12px; }
</style>
</head>

<body>

<h1>ğŸ”¥ Attack FD25 â€“ Profi panel vytÃ¡pÄ›nÃ­</h1>
<small>PoslednÃ­ aktualizace ThingSpeak: <span id="lastUpdate">â€“</span></small>

<!-- TEPLOTY -->
<div class="section grid">
  <div class="card"><div class="label">Kotel</div><div class="value" id="f5">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div class="label">VÃ½stup z kotle</div><div class="value" id="f2">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div class="label">ZpÃ¡teÄka kotle</div><div class="value" id="f1">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div class="label">Î”T (vÃ½stup âˆ’ zpÃ¡teÄka)</div><div class="value" id="dt">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div class="label">Teplota TUV</div><div class="value" id="f3">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div class="label">VenkovnÃ­ teplota</div><div class="value" id="f4">â€“</div><div class="unit">Â°C</div></div>
</div>

<!-- SPOTÅ˜EBA -->
<div class="section grid">
  <div class="card">
    <div class="label">DennÃ­ energie â€“ topenÃ­</div>
    <div class="value" id="dayHeat">â€“</div>
    <div class="unit">kWh</div>
  </div>

  <div class="card">
    <div class="label">MÄ›sÃ­ÄnÃ­ energie â€“ topenÃ­</div>
    <div class="value" id="monthHeat">â€“</div>
    <div class="unit">kWh</div>
  </div>

  <div class="card">
    <div class="label">UhlÃ­ â€“ topenÃ­ (tento mÄ›sÃ­c)</div>
    <div class="value" id="coalHeat">â€“</div>
    <div class="unit">kg</div>
  </div>

  <div class="card">
    <div class="label">Energie TUV â€“ tento mÄ›sÃ­c</div>
    <div class="value" id="monthTUV">â€“</div>
    <div class="unit">kWh</div>
  </div>
</div>

<!-- GRAF -->
<div class="section card">
  <h2>ğŸ“ˆ Teploty â€“ poslednÃ­ch 24 h</h2>
  <canvas id="chart"></canvas>
</div>

<script>
const CHANNEL_ID = 231269;
const FLOW_LH = 1080;      // prÅ¯tok topenÃ­ [l/h]
const BOILER_L = 125;      // objem bojleru
const COAL_PER_KWH = 0.27;

async function loadData() {
  const res = await fetch(`https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=96`);
  const data = await res.json();
  const feeds = data.feeds;
  if (feeds.length < 2) return;

  let dayHeat = 0;
  let monthHeat = 0;
  let monthTUV = 0;

  const now = new Date();
  const currentMonth = now.getMonth();

  for (let i = 1; i < feeds.length; i++) {
    const a = feeds[i-1];
    const b = feeds[i];

    const t1 = new Date(a.created_at);
    const t2 = new Date(b.created_at);
    const hours = (t2 - t1) / 3600000;
    if (hours <= 0 || hours > 1) continue;

    const out = parseFloat(b.field2);
    const ret = parseFloat(b.field1);

    if (!isNaN(out) && !isNaN(ret)) {
      const dT = out - ret;
      const power = 0.00116 * FLOW_LH * dT;
      const energy = power * hours;

      if (t2.getMonth() === currentMonth) {
        monthHeat += energy;
      }
      if (t2.toDateString() === now.toDateString()) {
        dayHeat += energy;
      }
    }

    const tuvA = parseFloat(a.field3);
    const tuvB = parseFloat(b.field3);
    if (!isNaN(tuvA) && !isNaN(tuvB)) {
      const dTtuv = tuvB - tuvA;
      if (dTtuv > 3 && t2.getMonth() === currentMonth) {
        monthTUV += BOILER_L * dTtuv * 0.001163;
      }
    }
  }

  const last = feeds.at(-1);
  document.getElementById('lastUpdate').textContent =
    new Date(last.created_at).toLocaleString('cs-CZ');

  document.getElementById('f1').textContent = parseFloat(last.field1).toFixed(1);
  document.getElementById('f2').textContent = parseFloat(last.field2).toFixed(1);
  document.getElementById('f3').textContent = parseFloat(last.field3).toFixed(1);
  document.getElementById('f4').textContent = parseFloat(last.field4).toFixed(1);
  document.getElementById('f5').textContent = parseFloat(last.field5).toFixed(1);

  document.getElementById('dt').textContent =
    (last.field2 - last.field1).toFixed(1);

  document.getElementById('dayHeat').textContent = dayHeat.toFixed(1);
  document.getElementById('monthHeat').textContent = monthHeat.toFixed(0);
  document.getElementById('coalHeat').textContent =
    (monthHeat * COAL_PER_KWH).toFixed(0);
  document.getElementById('monthTUV').textContent = monthTUV.toFixed(1);

  drawChart(feeds);
}

function drawChart(feeds) {
  const labels = feeds.map(f =>
    new Date(f.created_at).toLocaleTimeString('cs-CZ',{hour:'2-digit',minute:'2-digit'})
  );

  const datasets = [
    {label:'VÃ½stup', data:feeds.map(f=>f.field2)},
    {label:'ZpÃ¡teÄka', data:feeds.map(f=>f.field1)},
    {label:'TUV', data:feeds.map(f=>f.field3)},
    {label:'VenkovnÃ­', data:feeds.map(f=>f.field4)}
  ].map(d => ({
    ...d,
    borderWidth:2,
    tension:.3
  }));

  new Chart(document.getElementById('chart'), {
    type:'line',
    data:{labels,datasets},
    options:{
      responsive:true,
      plugins:{legend:{labels:{color:'#e5e7eb'}}},
      scales:{
        x:{ticks:{color:'#94a3b8'}},
        y:{ticks:{color:'#94a3b8'}}
      }
    }
  });
}

loadData();
</script>

</body>
</html>
