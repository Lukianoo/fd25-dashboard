<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8" />
<title>Attack FD25 â€“ PÅ™ehled teplot</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
  margin: 0;
  padding: 20px;
}
h1 { font-size: 1.8rem; margin-bottom: 5px; }
.update { opacity: 0.8; margin-bottom: 20px; }
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 20px;
}
.card {
  background: #020617;
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.4);
  text-align: center;
}
.value { font-size: 2.2rem; font-weight: bold; }
.unit { font-size: 1rem; opacity: 0.7; }
.small { font-size: 0.9rem; opacity: 0.7; }
canvas { margin-top: 10px; }
</style>
</head>

<body>

<h1>ğŸ”¥ Attack FD25 â€“ RodinnÃ½ dÅ¯m</h1>
<div class="update" id="updated">PoslednÃ­ aktualizace: â€“</div>

<div class="grid">
  <div class="card"><div>VÃ½stup z kotle</div><div class="value" id="f2">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div>Kotel</div><div class="value" id="f5">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div>ZpÃ¡teÄka</div><div class="value" id="f1">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div>TUV</div><div class="value" id="f3">â€“</div><div class="unit">Â°C</div></div>
  <div class="card"><div>VenkovnÃ­</div><div class="value" id="f4">â€“</div><div class="unit">Â°C</div></div>

  <div class="card"><div>Î”T (vÃ½stup âˆ’ zpÃ¡teÄka)</div><div class="value" id="dt">â€“</div><div class="unit">Â°C</div></div>

  <div class="card">
    <div>DennÃ­ energie TUV</div>
    <div class="value" id="day_kwh">â€“</div>
    <div class="unit">kWh</div>
  </div>

  <div class="card">
    <div>DennÃ­ uhlÃ­ BÃ­lina</div>
    <div class="value" id="day_coal">â€“</div>
    <div class="unit">kg</div>
  </div>

  <div class="card">
    <div>MÄ›sÃ­ÄnÃ­ energie TUV</div>
    <div class="value" id="month_kwh">â€“</div>
    <div class="unit">kWh</div>
  </div>

  <div class="card">
    <div>MÄ›sÃ­ÄnÃ­ uhlÃ­ BÃ­lina</div>
    <div class="value" id="month_coal">â€“</div>
    <div class="unit">kg</div>
  </div>
</div>

<div class="card" style="margin-top:30px;">
  <h2>ğŸ“ˆ Historie teplot</h2>
  <canvas id="chart"></canvas>
</div>

<script>
const CHANNEL_ID = 231269;
const RESULTS = 2880; // cca 30 dnÃ­ (15 min)

const BOJLER_L = 125;
const TARGET_TUV = 50;
const ETA = 0.75;
const COAL_KWH_KG = 5.0;

let chart;

function energyForTUV(tuv) {
  const dT = Math.max(0, TARGET_TUV - tuv);
  return (BOJLER_L * dT * 4.186) / 3600 / ETA;
}

async function loadData() {
  const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=${RESULTS}`;
  const res = await fetch(url);
  const data = await res.json();
  const feeds = data.feeds;
  const last = feeds[feeds.length - 1];

  document.getElementById('updated').textContent =
    'PoslednÃ­ aktualizace: ' +
    new Date(last.created_at).toLocaleString('cs-CZ');

  for (let i = 1; i <= 5; i++) {
    const v = last[`field${i}`];
    document.getElementById(`f${i}`).textContent =
      v !== null ? Number(v).toFixed(1) : 'â€“';
  }

  const dt = Number(last.field2) - Number(last.field1);
  document.getElementById('dt').textContent =
    !isNaN(dt) ? dt.toFixed(1) : 'â€“';

  const now = new Date(last.created_at);
  let dayKwh = 0;
  let monthKwh = 0;

  feeds.forEach(f => {
    if (f.field3 === null) return;
    const t = new Date(f.created_at);
    const e = energyForTUV(Number(f.field3));

    if ((now - t) / 36e5 <= 24) dayKwh += e;
    if ((now - t) / 36e5 <= 24 * 30) monthKwh += e;
  });

  document.getElementById('day_kwh').textContent = dayKwh.toFixed(1);
  document.getElementById('day_coal').textContent = (dayKwh / COAL_KWH_KG).toFixed(2);
  document.getElementById('month_kwh').textContent = monthKwh.toFixed(1);
  document.getElementById('month_coal').textContent = (monthKwh / COAL_KWH_KG).toFixed(2);

  const labels = feeds.map(f =>
    new Date(f.created_at).toLocaleDateString('cs-CZ', { day:'2-digit', month:'2-digit' })
  );

  const datasets = [
    { label: 'VÃ½stup', field: 'field2' },
    { label: 'ZpÃ¡teÄka', field: 'field1' },
    { label: 'TUV', field: 'field3' }
  ].map(cfg => ({
    label: cfg.label,
    data: feeds.map(f => f[cfg.field]),
    borderWidth: 2,
    tension: 0.3
  }));

  if (chart) chart.destroy();
  chart = new Chart(document.getElementById('chart'), {
    type: 'line',
    data: { labels, datasets },
    options: { responsive: true }
  });
}

loadData();
setInterval(loadData, 60000);
</script>

</body>
</html>
